{% extends 'base.html' %}

{% block content %}
<div class="flex-1 flex flex-col items-center justify-center px-6 py-12 max-w-2xl mx-auto w-full">
    <div id="intro-layer"
        class="fixed inset-0 z-50 bg-white dark:bg-slate-900 flex items-center justify-center transition-opacity duration-300">
        <div class="relative">
            <img id="intro-postbox" src="/static/images/postbox/main.png"
                class="w-64 h-64 object-contain animate-postbox-entrance" alt="Intro Postbox">
        </div>
    </div>

    <div id="progress-container" class="hidden w-full max-w-md bg-slate-800 h-1 rounded-full mb-16 overflow-hidden opacity-60">
        <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-indigo-400 h-full transition-all duration-700 ease-out"
            style="width: 25%"></div>
    </div>

    <section id="step-1" class="w-full animate-fade-in text-center max-w-md mx-auto">
        <h2 class="text-2xl md:text-3xl font-bold mb-3 text-white tracking-tight">ìš°ì²´í†µì˜ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”</h2>
        <p class="text-slate-400 mb-12 text-sm md:text-base">ì¹œêµ¬ë“¤ì´ ì´ ì´ë¦„ì„ ë³´ê³  í¸ì§€ë¥¼ ë³´ë‚¼ ê±°ì˜ˆìš”.</p>

        <div class="space-y-8">
            <div class="relative group">
                <input type="text" id="postbox-name"
                    class="w-full px-4 py-5 text-center text-xl font-bold bg-slate-800/50 border-b-2 border-slate-700 focus:border-blue-500 focus:outline-none text-white transition-all placeholder:text-slate-500"
                    placeholder="ë¡œë”© ì¤‘...">
            </div>

            <div class="text-left">
                <label class="block text-xs font-semibold text-slate-500 mb-3 ml-1 uppercase tracking-wider">ë‚˜ì—ê²Œ í•˜ê³  ì‹¶ì€ í•œ ë§ˆë””</label>
                <textarea id="prayer-topic" rows="4"
                    class="w-full px-5 py-4 bg-slate-800/40 border border-slate-700/50 rounded-2xl focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 outline-none transition-all text-white resize-none shadow-inner"
                    placeholder="ì˜¬í•´ ë‚˜ì—ê²Œ ì£¼ëŠ” ì‘ì›ì˜ ë©”ì‹œì§€ë‚˜ ê¸°ë„ì œëª©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
            </div>
        </div>

        <button onclick="nextStep(2)" 
            class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl mt-16 font-bold shadow-lg transition-all active:scale-[0.98]">
            ë‹¤ìŒ ë‹¨ê³„ë¡œ
        </button>
    </section>

    <section id="step-2" class="w-full hidden animate-fade-in max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-2 text-white text-center">ë©”ì‹œì§€ ê³µê°œ ì„¤ì •</h2>
        <p class="text-slate-500 mb-10 text-center">ë„ì°©í•œ ë©”ì‹œì§€ë¥¼ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ê³µê°œí• ê¹Œìš”?</p>

        <div class="space-y-4">
            <label class="flex items-center p-6 bg-slate-800 rounded-2xl border-2 border-blue-500 cursor-pointer transition-all">
                <input type="radio" name="privacy" value="public" checked class="w-6 h-6 text-blue-500">
                <div class="ml-4 text-left">
                    <p class="font-bold text-white">ëª¨ë‘ì—ê²Œ ê³µê°œ</p>
                    <p class="text-sm text-slate-400">ë°©ë¬¸ì ëˆ„êµ¬ë‚˜ ë©”ì‹œì§€ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </label>
            <label class="flex items-center p-6 bg-slate-800 rounded-2xl border-2 border-transparent hover:border-slate-600 cursor-pointer transition-all">
                <input type="radio" name="privacy" value="private" class="w-6 h-6 text-blue-500">
                <div class="ml-4 text-left">
                    <p class="font-bold text-white">ë‚˜ë§Œ ë³´ê¸°</p>
                    <p class="text-sm text-slate-400">ìš°ì²´í†µ ì£¼ì¸ì¸ ë³¸ì¸ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </label>
        </div>

        <div class="flex gap-3 mt-12">
            <button onclick="nextStep(1)" class="flex-1 py-4 bg-slate-700 text-white rounded-2xl font-bold">ì´ì „ìœ¼ë¡œ</button>
            <button onclick="nextStep(3)" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">ì„¤ì • ì™„ë£Œ</button>
        </div>
    </section>

    <section id="step-3" class="w-full hidden animate-fade-in max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-2 text-white text-center">ìš°í¸í•¨ ìƒ‰ìƒ ì„ íƒ</h2>
        <p class="text-slate-500 mb-8 text-center">ë‚˜ë§Œì˜ ìš°í¸í•¨ ìƒ‰ìƒì„ ê³¨ë¼ë³´ì„¸ìš”.</p>

        <div class="flex justify-center mb-12">
            <div class="relative w-64 h-64 flex items-center justify-center">
                <img id="postbox-img" src="/static/images/postbox/yellow.png" alt="Preview"
                    class="object-contain w-full h-full transition-all duration-300 drop-shadow-2xl">
            </div>
        </div>

        <div class="flex justify-center gap-4 flex-wrap mb-14">
            <button onclick="changeColor('yellow')" class="color-btn w-12 h-12 rounded-full border-4 border-white bg-[#FFD700]" data-color="yellow"></button>
            <button onclick="changeColor('red')" class="color-btn w-12 h-12 rounded-full border-4 border-transparent bg-[#FF4D4D]" data-color="red"></button>
            <button onclick="changeColor('blue')" class="color-btn w-12 h-12 rounded-full border-4 border-transparent bg-[#4D94FF]" data-color="blue"></button>
            <button onclick="changeColor('pink')" class="color-btn w-12 h-12 rounded-full border-4 border-transparent bg-[#FF69B4]" data-color="pink"></button>
            <button onclick="changeColor('green')" class="color-btn w-12 h-12 rounded-full border-4 border-transparent bg-[#22C55E]" data-color="green"></button>
        </div>

        <div class="flex gap-3">
            <button onclick="nextStep(2)" class="flex-1 py-4 bg-slate-700 text-white rounded-2xl font-bold">ì´ì „ìœ¼ë¡œ</button>
            <button onclick="createPostbox()" class="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">ìš°ì²´í†µ ë§Œë“¤ê¸°</button>
        </div>
    </section>

    <section id="step-4" class="w-full hidden animate-fade-in text-center max-w-md mx-auto">
        <div class="mb-6"><span class="text-5xl">ğŸ‰</span></div>
        <h2 class="text-3xl font-bold mb-2 text-white" id="summary-name"></h2>

        <div class="flex justify-center mb-8">
            <div class="relative w-fit">
                <img id="final-postbox-img" src="" class="w-56 h-56 object-contain drop-shadow-2xl">
                <div id="summary-badge" class="absolute -top-2 -right-2 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transform rotate-12"></div>
            </div>
        </div>

        <div class="flex items-center gap-2 p-3 bg-slate-900 rounded-2xl mb-8 border-2 border-slate-800">
            <input id="postbox-url" type="text" readonly class="flex-1 bg-transparent px-3 text-sm text-white outline-none">
            <button onclick="copyURL()" class="px-5 py-2 bg-blue-500 text-white rounded-xl text-sm font-bold">ë³µì‚¬</button>
        </div>

        <button onclick="goToMyPostbox()" class="w-full py-4 bg-slate-700 text-white rounded-2xl font-bold mb-3">ë‚´ ìš°ì²´í†µìœ¼ë¡œ ì´ë™í•˜ê¸°</button>
    </section>
</div>

<script>
    let selectedColor = 'yellow';
    const SUPABASE_URL = "{{ supabase_url }}";
    const SUPABASE_KEY = "{{ supabase_key }}";
    let supabaseClient;

    // ì´ˆê¸°í™” ë° ì„¸ì…˜ ì²´í¬ ë³´ì™„
    async function init() {
        // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (DB ì €ì¥ ë“±ì„ ìœ„í•´ í•„ìš”)
        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // 1. Flaskê°€ ë„˜ê²¨ì¤€ user_nameìœ¼ë¡œ ì¦‰ì‹œ placeholder ì„¤ì •
        const userName = "{{ user_name }}"; 
        const nameInput = document.getElementById('postbox-name');
        if (nameInput) {
            nameInput.placeholder = `ê¿ˆê¾¸ëŠ” ${userName}ì˜ ë§ì”€ì§€ê¸° ìš°ì²´í†µ`;
        }

        // 2. ì„¸ì…˜ ì²´í¬ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë°”ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        startIntroAnimation();
    }

        // ìœ ì € ì •ë³´ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ë¶„ë¦¬
        function updateUserInfo(user) {
            const nameInput = document.getElementById('postbox-name');
            if (user && nameInput) {
                const userName = user.user_metadata?.full_name || user.email.split('@')[0];
                nameInput.placeholder = `ê¿ˆê¾¸ëŠ” ${userName}ì˜ ë§ì”€ì§€ê¸° ìš°ì²´í†µ`;
                console.log("Placeholder ì„¤ì • ì™„ë£Œ:", userName);
            }
        }

    async function checkUserSession() {
        try {
            // 1. í˜„ì¬ ì¦‰ì‹œ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸° ì‹œë„
            let { data: { session } } = await supabaseClient.auth.getSession();

            // 2. ë§Œì•½ ì„¸ì…˜ì´ ì—†ë‹¤ë©´, ì•„ì£¼ ì§§ì€ ì‹œê°„(0.5ì´ˆ) ëŒ€ê¸° í›„ ë‹¤ì‹œ ì‹œë„ (SDK ì´ˆê¸°í™” ì‹œê°„ í™•ë³´)
            if (!session) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const retry = await supabaseClient.auth.getSession();
                session = retry.data.session;
            }

            if (!session) {
                console.warn("ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                window.location.href = "/login";
                return false;
            }

            // ì„¸ì…˜ì´ ìˆë‹¤ë©´ ìœ ì € ì •ë³´ ì„¤ì •
            const user = session.user;
            const nameInput = document.getElementById('postbox-name');
            if (nameInput) {
                const userName = user.user_metadata?.full_name || user.email.split('@')[0];
                nameInput.placeholder = `ê¿ˆê¾¸ëŠ” ${userName}ì˜ ë§ì”€ì§€ê¸° ìš°ì²´í†µ`;
                // placeholderê°€ ì˜ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ë¡œê·¸ë¡œ í™•ì¸
                console.log("Placeholder ì„¤ì • ì™„ë£Œ:", userName);
            }
            
            return true;
        } catch (e) {
            console.error("ì„¸ì…˜ ì²´í¬ ì—ëŸ¬:", e);
            return false;
        }
    }

    function startIntroAnimation() {
        const introLayer = document.getElementById('intro-layer');
        const introPostbox = document.getElementById('intro-postbox');
        
        setTimeout(() => {
            if (introPostbox) {
                introPostbox.classList.add('animate-postbox-zoom');
            }
            if (introLayer) introLayer.classList.add('white-out');

            setTimeout(() => {
                if (introLayer) {
                    introLayer.style.opacity = '0';
                    setTimeout(() => {
                        introLayer.classList.add('hidden');
                        document.getElementById('progress-container').classList.remove('hidden');
                        nextStep(1);
                    }, 500);
                }
            }, 1000);
        }, 800);
    }

    function nextStep(step) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`step-${step}`).classList.remove('hidden');
        
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = `${(step / 4) * 100}%`;

        if (step === 4) updateSummary();
    }

    function changeColor(color) {
        selectedColor = color;
        document.getElementById('postbox-img').src = `/static/images/postbox/${color}.png`;
        
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.remove('border-white');
            btn.classList.add('border-transparent');
        });
        event.currentTarget.classList.replace('border-transparent', 'border-white');
    }

    async function createPostbox() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const payload = {
            user_id: user.id,
            name: document.getElementById('postbox-name').value || document.getElementById('postbox-name').placeholder,
            privacy: document.querySelector('input[name="privacy"]:checked').value,
            color: selectedColor,
            prayer_topic: document.getElementById('prayer-topic').value
        };

        try {
            const response = await fetch('/api/create-postbox', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.postbox_id) {
                document.getElementById('postbox-url').value = result.original_url;
                nextStep(4);
            }
        } catch (e) {
            alert("ìš°ì²´í†µ ìƒì„± ì‹¤íŒ¨");
        }
    }

    function updateSummary() {
        const name = document.getElementById('postbox-name').value || document.getElementById('postbox-name').placeholder;
        const privacy = document.querySelector('input[name="privacy"]:checked').value;
        
        document.getElementById('summary-name').innerText = name;
        document.getElementById('final-postbox-img').src = `/static/images/postbox/${selectedColor}.png`;
        
        const badge = document.getElementById('summary-badge');
        badge.innerText = privacy === 'public' ? 'ğŸ”“ ëª¨ë‘ ê³µê°œ' : 'ğŸ”’ ë‚˜ë§Œ ë³´ê¸°';
        badge.className = `absolute -top-2 -right-2 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transform rotate-12 ${privacy === 'public' ? 'bg-green-500' : 'bg-slate-500'} text-white border-2 border-white`;
    }

    function copyURL() {
        const urlInput = document.getElementById('postbox-url');
        urlInput.select();
        document.execCommand('copy');
        alert('ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function goToMyPostbox() {
        const name = document.getElementById('postbox-name').value || document.getElementById('postbox-name').placeholder;
        window.location.href = `/postbox/${encodeURIComponent(name)}?color=${selectedColor}&role=owner`;
    }

    window.onload = init;
</script>

<style>
    /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ë™ì¼ */
    .animate-postbox-zoom { animation: postbox-zoom-in 1.0s cubic-bezier(0.5, 0, 0.75, 0) forwards; }
    @keyframes postbox-zoom-in {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(15); filter: brightness(8); opacity: 0; }
    }
    .white-out { background-color: white !important; }
</style>
{% endblock %}