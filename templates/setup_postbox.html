{% extends 'base.html' %}

{% block content %}
<div class="flex-1 flex flex-col items-center justify-center px-6 py-12 max-w-2xl mx-auto w-full">
    <div id="intro-layer"
        class="fixed inset-0 z-50 bg-white dark:bg-slate-900 flex items-center justify-center transition-opacity duration-300">
        <div class="relative">
            <img id="intro-postbox" src="/static/images/postbox/main.png"
                class="w-64 h-64 object-contain animate-postbox-entrance" alt="Intro Postbox">
            <div id="glow-effect"
                class="absolute inset-0 bg-white rounded-full mix-blend-overlay opacity-0 scale-0 transition-all duration-700">
            </div>
        </div>
    </div>
    <div class="w-full bg-slate-200 dark:bg-slate-800 h-1.5 rounded-full mb-12 overflow-hidden">
        <div id="progress-bar" class="bg-primary dark:bg-accent h-full transition-all duration-500"
            style="width: 33.3%"></div>
    </div>

    <section id="step-1" class="w-full animate-fade-in text-center">
        <h2 class="text-3xl font-bold font-serif mb-2 dark:text-white">ìš°ì²´í†µì˜ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”</h2>
        <p class="text-slate-500 mb-10">ì¹œêµ¬ë“¤ì´ ì´ ì´ë¦„ì„ ë³´ê³  í¸ì§€ë¥¼ ë³´ë‚¼ ê±°ì˜ˆìš”.</p>
    
        <div class="relative max-w-sm mx-auto">
            <input type="text" id="postbox-name"
                class="w-full px-4 py-4 text-center text-xl font-bold bg-slate-50 dark:bg-slate-800 border-b-4 border-primary focus:outline-none dark:text-white transition-all"
                placeholder="ê¿ˆê¾¸ëŠ” {{user_name}} ìš°ì²´í†µ" value="">
        </div>
    
        <button onclick="nextStep(2)" class="w-full py-4 bg-primary text-white rounded-2xl mt-16 font-bold shadow-lg">ë‹¤ìŒ
            ë‹¨ê³„ë¡œ</button>
    </section>
    <section id="step-2" class="w-full hidden animate-fade-in">
        <h2 class="text-2xl font-bold font-serif mb-2 dark:text-white text-center">ë©”ì‹œì§€ ê³µê°œ ì„¤ì •</h2>
        <p class="text-slate-500 mb-10 text-center">ë„ì°©í•œ ë©”ì‹œì§€ë¥¼ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ê³µê°œí• ê¹Œìš”?</p>
    
        <div class="space-y-4">
            <label
                class="flex items-center p-6 bg-white dark:bg-slate-800 rounded-2xl border-2 border-primary cursor-pointer transition-all shadow-sm">
                <input type="radio" name="privacy" value="public" checked class="w-6 h-6 text-primary">
                <div class="ml-4 text-left">
                    <p class="font-bold dark:text-white">ëª¨ë‘ì—ê²Œ ê³µê°œ</p>
                    <p class="text-sm text-slate-500">ë°©ë¬¸ì ëˆ„êµ¬ë‚˜ ë©”ì‹œì§€ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </label>
            <label
                class="flex items-center p-6 bg-white dark:bg-slate-800 rounded-2xl border-2 border-transparent hover:border-slate-200 cursor-pointer transition-all">
                <input type="radio" name="privacy" value="private" class="w-6 h-6 text-primary">
                <div class="ml-4 text-left">
                    <p class="font-bold dark:text-white">ë‚˜ë§Œ ë³´ê¸°</p>
                    <p class="text-sm text-slate-500">ìš°ì²´í†µ ì£¼ì¸ì¸ ë³¸ì¸ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </label>
        </div>
    
        <button onclick="nextStep(3)" class="w-full py-4 bg-primary text-white rounded-2xl mt-12 font-bold shadow-lg">ì„¤ì •
            ì™„ë£Œ</button>
    </section>
    <section id="step-3" class="w-full hidden animate-fade-in">
        <h2 class="text-2xl font-bold font-serif mb-2 dark:text-white text-center">ìš°í¸í•¨ ìƒ‰ìƒ ì„ íƒ</h2>
        <p class="text-slate-500 mb-8 text-center">ë‚˜ë§Œì˜ ìš°í¸í•¨ ìƒ‰ìƒì„ ê³¨ë¼ë³´ì„¸ìš”.</p>
    
        <div class="flex justify-center mb-12">
            <div class="relative w-72 h-72 flex items-center justify-center">
                <img id="postbox-img" src="/static/images/postbox/yellow.png" alt="Postbox Preview"
                    class="object-contain w-full h-full transition-all duration-300 drop-shadow-2xl">
            </div>
        </div>
    
        <div class="flex justify-center gap-5 flex-wrap">
            <button onclick="changeColor('yellow')"
                class="color-btn w-10 h-10 rounded-full border-2 border-slate-900 dark:border-white shadow-lg transition-all hover:scale-125 bg-[#FFD700]"
                data-color="yellow"></button>
    
            <button onclick="changeColor('red')"
                class="color-btn w-10 h-10 rounded-full border-2 border-transparent shadow-md transition-all hover:scale-125 bg-[#FF4D4D]"
                data-color="red"></button>
    
            <button onclick="changeColor('blue')"
                class="color-btn w-10 h-10 rounded-full border-2 border-transparent shadow-md transition-all hover:scale-125 bg-[#4D94FF]"
                data-color="blue"></button>
    
            <button onclick="changeColor('pink')"
                class="color-btn w-10 h-10 rounded-full border-2 border-transparent shadow-md transition-all hover:scale-125 bg-[#FF69B4]"
                data-color="pink"></button>
    
            <button onclick="changeColor('green')"
                class="color-btn w-10 h-10 rounded-full border-2 border-transparent shadow-md transition-all hover:scale-125 bg-[#22C55E]"
                data-color="green"></button>
        </div>
    
        <button onclick="nextStep(4)"
            class="w-full py-4 bg-primary text-white rounded-2xl mt-14 font-bold shadow-lg shadow-primary/30 transition-all hover:brightness-110">
            ì´ ìƒ‰ìƒìœ¼ë¡œ ê²°ì •í•˜ê¸°
        </button>
    </section>
<section id="step-4" class="w-full hidden animate-fade-in text-center">
    <div class="mb-6">
        <span class="text-5xl">ğŸ‰</span>
    </div>

    <h2 class="text-3xl font-bold font-serif mb-2 dark:text-white" id="summary-name"></h2>

    <div class="flex justify-center mb-8">
        <div class="relative w-fit"> <img id="final-postbox-img" src="" alt="Final Postbox"
                class="w-56 h-56 object-contain drop-shadow-2xl">

            <div id="summary-badge"
                class="absolute top-2 -right-4 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transform rotate-12 transition-all z-10">
            </div>
        </div>
    </div>

    <p class="text-slate-500 mb-8">ì„¤ì •í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ë§í¬ë¥¼ ê³µìœ í•´ë³´ì„¸ìš”.</p>

    <div
        class="flex items-center gap-2 p-3 bg-white dark:bg-slate-900 rounded-2xl mb-4 border-2 border-slate-100 dark:border-slate-800">
        <input id="postbox-url" type="text" readonly value=""
            class="flex-1 bg-transparent px-3 text-sm font-medium dark:text-white outline-none">
        <button onclick="copyURL()"
            class="px-5 py-2 bg-slate-900 dark:bg-accent text-white dark:text-slate-900 rounded-xl text-sm font-bold">
            ë³µì‚¬
        </button>
    </div>

    <div class="grid grid-cols-1 gap-3 mt-8">
        <button onclick="shareToInstagram()"
            class="flex items-center justify-center gap-3 py-4 bg-gradient-to-tr from-[#f09433] via-[#e6683c] to-[#bc1888] text-white rounded-2xl font-bold shadow-lg transform transition active:scale-95">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.355 2.618 6.778 6.98 6.978 1.28.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z" />
            </svg>
            ìŠ¤í† ë¦¬ ê³µìœ  ì´ë¯¸ì§€ ì €ì¥
        </button>
        <button onclick="goToMyPostbox()"
            class="py-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 rounded-2xl font-bold">
            ë‚´ ìš°ì²´í†µìœ¼ë¡œ ì´ë™í•˜ê¸°
        </button>
    </div>
</section>
</div>
<style>
    /* [ì…ì¥] ì‘ê²Œ ë‚˜íƒ€ë‚˜ì„œ ë¹ ë¥´ê²Œ ì‹œì•¼ í™•ë³´ */
    @keyframes postbox-entrance {
        0% {
            transform: scale(0.3);
            opacity: 0;
            filter: blur(5px);
        }

        100% {
            transform: scale(1);
            opacity: 1;
            filter: blur(0);
        }
    }

    /* [ëª°ì…í˜• í‡´ì¥] ë“±ì¥í•˜ìë§ˆì ê°€ì†ë„ë¥¼ ë¶™ì—¬ í™”ë©´ì„ ëš«ê³  ë‚˜ê° */
    @keyframes postbox-zoom-in {
        0% {
            transform: scale(1);
            filter: brightness(1);
            opacity: 1;
        }

        40% {
            filter: brightness(1.5);
            /* ì„œì„œíˆ ë°ì•„ì§ */
        }

        100% {
            transform: scale(15);
            /* í›¨ì”¬ ë” í¬ê²Œ í™•ëŒ€ */
            filter: brightness(8);
            /* í™”ì´íŠ¸ì•„ì›ƒ ê·¹ëŒ€í™” */
            opacity: 0;
        }
    }

    .animate-postbox-entrance {
        animation: postbox-entrance 0.3s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .animate-postbox-zoom {
        animation: postbox-zoom-in 1.0s cubic-bezier(0.5, 0, 0.75, 0) forwards;
    }

    #intro-layer {
        background-color: #f8fafc;
        /* ë°ì€ ë°°ê²½ìœ¼ë¡œ ì‹œì‘ */
        transition: background-color 0.3s ease;
    }

    #intro-layer.white-out {
        background-color: white;
    }

/* ê³µê°œ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.badge-public {
    background-color: #22C55E; /* ì´ˆë¡ìƒ‰ */
    color: white;
    border: 2px solid white;
}

/* ë¹„ê³µê°œ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.badge-private {
    background-color: #64748B; /* íšŒìƒ‰ */
    color: white;
    border: 2px solid white;
}

/* ë°°ì§€ê°€ ì‚´ì§ ë–  ìˆëŠ” ëŠë‚Œì˜ ì• ë‹ˆë©”ì´ì…˜ */
#summary-badge {
    animation: badge-float 2s ease-in-out infinite;
}

@keyframes badge-float {
    0%, 100% { transform: rotate(12deg) translateY(0); }
    50% { transform: rotate(12deg) translateY(-5px); }
}
</style>


<script>
    window.onload = function () {
        const introLayer = document.getElementById('intro-layer');
        const introPostbox = document.getElementById('intro-postbox');

        // 1. ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ì¦‰ì‹œ ì‹œì‘ (ì´ë¯¸ HTMLì— í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ ë°”ë¡œ ì‹¤í–‰ë¨)

        // 2. ë“±ì¥ í›„ ì•„ì£¼ ì§§ì€ ëŒ€ê¸°(0.3ì´ˆ) í›„ ë°”ë¡œ ì¤Œì¸ ì‹œì‘
        setTimeout(() => {
            // ìš°ì²´í†µ ì¤Œì¸ ì• ë‹ˆë©”ì´ì…˜ êµì²´
            introPostbox.classList.remove('animate-postbox-entrance');
            introPostbox.classList.add('animate-postbox-zoom');

            // ë°°ê²½ì„ ì™„ì „íˆ í•˜ì–—ê²Œ ë§Œë“¦
            introLayer.classList.add('white-out');

            // 3. ì¤Œì¸ ê°€ì†ë„ê°€ ë¶™ì—ˆì„ ë•Œ ë ˆì´ì–´ë¥¼ ì¹˜ìš°ê³  ë‹¤ìŒ í™”ë©´ ì¤€ë¹„
            setTimeout(() => {
                introLayer.style.opacity = '0';

                setTimeout(() => {
                    introLayer.classList.add('hidden');
                    // ì„¤ì • í™”ë©´ êµ¬ì„± ìš”ì†Œë“¤ ë³´ì´ê¸°
                    document.getElementById('progress-container').classList.remove('hidden');
                    nextStep(1);
                }, 500); // í˜ì´ë“œì•„ì›ƒ ë§ˆë¬´ë¦¬
            }, 700); // ì¤Œì¸ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ê°„ ì§€ì 

        }, 800); // ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ë§ì¶¤ (ë“±ì¥í•˜ìë§ˆì ë°”ë¡œ ì»¤ì§)
    };

    let selectedColor = 'yellow';

    function changeColor(colorName) {
        selectedColor = colorName;
        const imgElement = document.getElementById('postbox-img');

        // 1. ì´ë¯¸ì§€ ë³€ê²½ (ê²½ë¡œ ê·œì¹™ ì ìš©)
        // imgElement.style.transform = 'scale(0.9)';
        // imgElement.style.opacity = '0.5';
        imgElement.style.transform = 'translateY(-10px)'; // ì‚´ì§ ì í”„í•˜ëŠ” íš¨ê³¼
        imgElement.style.opacity = '0.7';

        setTimeout(() => {
            imgElement.src = `/static/images/postbox/${colorName}.png`;
            // imgElement.style.transform = 'scale(1)';
            imgElement.style.transform = 'translateY(0px)';
            imgElement.style.opacity = '1';
        }, 150);


        // ë²„íŠ¼ í…Œë‘ë¦¬ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.remove('border-slate-900', 'dark:border-white');
            btn.classList.add('border-transparent');
        });
        // í´ë¦­ëœ ë²„íŠ¼ì— í…Œë‘ë¦¬ ì¶”ê°€
        event.currentTarget.classList.remove('border-transparent');
        event.currentTarget.classList.add('border-slate-900', 'dark:border-white');

        // // 2. ë²„íŠ¼ ì„ íƒ í‘œì‹œ (í…Œë‘ë¦¬ íš¨ê³¼)
        // document.querySelectorAll('.color-btn').forEach(btn => {
        //     btn.classList.replace('border-slate-400', 'border-transparent');
        //     btn.style.borderColor = 'transparent';
        // });
        // event.currentTarget.style.borderColor = '#334155'; // ê°•ì¡° í…Œë‘ë¦¬
    }

    // ê¸°ì¡´ nextStep í•¨ìˆ˜ ìˆ˜ì •
    function nextStep(step) {

        const nameInput = document.getElementById('postbox-name');

        // Step 1ì—ì„œ 2ë¡œ ë„˜ì–´ê°ˆ ë•Œ ì´ë¦„ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ê°•ì œ ì ìš©
        if (step === 2 && !nameInput.value.trim()) {
            const defaultName = "{{ user_name }}ì˜ ìš°ì²´í†µ";
            nameInput.value = defaultName;
        }
        // 1. Step 4ë¡œ ë„˜ì–´ê°ˆ ë•Œ ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
        if (step === 4) {
            const name = document.getElementById('postbox-name').value;
            const privacy = document.querySelector('input[name="privacy"]:checked').value;
            const selectedImgSrc = document.getElementById('postbox-img').src;
            
            // 1. ì´ë¦„ê³¼ ì´ë¯¸ì§€ ë°˜ì˜
            document.getElementById('summary-name').innerText = name;
            document.getElementById('final-postbox-img').src = selectedImgSrc;

            // 2. ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('summary-badge');
            if (privacy === 'public') {
                badge.innerText = 'ğŸ”“ ëª¨ë‘ì—ê²Œ ê³µê°œ';
                badge.className = 'absolute -top-2 -right-2 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transform rotate-12 transition-all badge-public';
            } else {
                badge.innerText = 'ğŸ”’ ë‚˜ë§Œ ë³´ê¸°';
                badge.className = 'absolute -top-2 -right-2 px-3 py-1.5 rounded-full text-xs font-bold shadow-lg transform rotate-12 transition-all badge-private';
            }

            // 3.ì‹¤ì œ URL ìƒì„± (ì¶”í›„ ë°±ì—”ë“œ ì—°ë™ ì‹œ id ê°’ ë°˜ì˜)
            const baseUrl = window.location.origin;
            document.getElementById('postbox-url').value = `${baseUrl}/postbox/${encodeURIComponent(name)}`;
        }

        // 2. í™”ë©´ ì „í™˜
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        const targetSection = document.getElementById(`step-${step}`);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }

        // 3. í”„ë¡œê·¸ë ˆìŠ¤ ë°” (ì „ì²´ 4ë‹¨ê³„ë¡œ ê³„ì‚°)
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            const progress = (step / 4) * 100;
            progressBar.style.width = `${progress}%`;
        }
    }

    // URL ë³µì‚¬ í•¨ìˆ˜
    function copyURL() {
        const urlInput = document.getElementById('postbox-url');
        urlInput.select();
        document.execCommand('copy');
        alert('ìš°ì²´í†µ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ì¸ìŠ¤íƒ€ ê³µìœ  (ì´ë¯¸ì§€ ì €ì¥ ì•ˆë‚´)
    function shareToInstagram() {
        alert('ì¸ìŠ¤íƒ€ê·¸ë¨ ìŠ¤í† ë¦¬ìš© ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. \nì´ë¯¸ì§€ë¥¼ ì €ì¥í•œ ë’¤ ì¸ìŠ¤íƒ€ê·¸ë¨ì—ì„œ ë§í¬ ìŠ¤í‹°ì»¤ì™€ í•¨ê»˜ í™œìš©í•´ ë³´ì„¸ìš”!');
        // ì—¬ê¸°ì— ë‚˜ì¤‘ì— Canvas ì´ë¯¸ì§€ ìƒì„± ë¡œì§ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    }
    function goToMyPostbox() {
        const name = document.getElementById('postbox-name').value;
        const privacy = document.querySelector('input[name="privacy"]:checked').value;
        // selectedColorëŠ” ê¸°ì¡´ì— ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬ë˜ê³  ìˆìŠµë‹ˆë‹¤.

        // URL ìƒì„± (ì˜ˆ: /postbox/ë‚˜ì˜ìš°ì²´í†µ?color=blue&privacy=public)
        const targetUrl = `/postbox/${encodeURIComponent(name)}?color=${selectedColor}&privacy=${privacy}&role=owner`;

        // í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = targetUrl;
    }
</script>
{% endblock %}