<div
    class="relative flex-1 flex flex-col items-center justify-center px-6 py-16 overflow-hidden transition-colors duration-500">

    <!-- ë°˜ì§ì´ëŠ” ë³„  -->
    <div class="absolute inset-0 opacity-0 dark:opacity-40 transition-opacity duration-1000">
        {% for i in range(50) %}
        <div class="absolute w-1 h-1 bg-accent rounded-full animate-twinkle" style="left: {{ range(0, 100) | random }}%; 
                    top: {{ range(0, 100) | random }}%; 
                    animation-delay: {{ (range(0, 30) | random)/10 }}s;
                    animation-duration: {{ (range(20, 50) | random)/10 }}s;">
        </div>
        {% endfor %}
    </div>

    <div class="relative z-10 flex flex-col items-center text-center max-w-md">
        <!-- ìš°ì²´í†µ ì´ë¯¸ì§€ -->
        <div class="relative mb-12 animate-float">
            <div class="w-48 h-48 mx-auto relative flex items-center justify-center">
                <img src="{{ url_for('static', filename='images/red_postbox.png') }}" alt="ë¹¨ê°„ ìš°ì²´í†µ"
                    class="w-full h-full object-contain drop-shadow-2xl">

                <div
                    class="absolute -bottom-4 left-1/2 -translate-x-1/2 w-24 h-4 bg-black/10 dark:bg-white/5 blur-xl rounded-[100%]">
                </div>
            </div>

            <div
                class="absolute inset-0 -z-10 blur-[60px] opacity-30 dark:opacity-40 bg-red-400 dark:bg-red-500 rounded-full scale-125 transition-opacity">
            </div>
        </div>

        <h1
            class="text-4xl sm:text-5xl font-bold mb-6 font-serif tracking-tight text-slate-900 dark:text-white transition-colors">
            ë§ì”€ìš°ì²´í†µ
        </h1>

        <div class="space-y-1 mb-10">
            <p class="text-lg text-slate-600 dark:text-slate-300 transition-colors">ë‚˜ë¥¼ ìƒê°í•˜ëŠ” ì‚¬ëŒë“¤ì´ ë³´ë‚´ì£¼ëŠ”</p>
            <p class="text-xl text-primary dark:text-accent font-bold transition-colors">í•œ í•´ë¥¼ í•¨ê»˜í•  ë§ì”€ì„ ë°›ì•„ë³´ì„¸ìš”</p>
        </div>

        <div
            class="px-8 py-6 bg-white dark:bg-white/10 backdrop-blur-md rounded-2xl border border-slate-200 dark:border-white/20 shadow-xl dark:shadow-2xl hover:scale-105 transition-all duration-500 cursor-default">
            <p class="text-base text-slate-800 dark:text-white/90 leading-relaxed font-serif italic">
                "ë„¤ ë§ì”€ì€ ë‚´ ë°œì— ë“±ì´ìš”<br />ë‚´ ê¸¸ì— ë¹›ì´ë‹ˆì´ë‹¤"
            </p>
            <p class="text-[11px] text-primary dark:text-accent/80 mt-4 font-bold tracking-[0.2em] uppercase">ì‹œí¸ 119:105
            </p>
        </div>

        <div class="mt-8 flex flex-col gap-3 w-full max-w-[280px]">
            {% if is_logged_in %}
            <!-- ë¡œê·¸ì¸ ëœ ìƒíƒœ: ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° -->
            <div class="flex flex-col gap-3 w-full animate-fade-in-up">
                <div class="text-center mb-6">
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-0.5">í™˜ì˜í•©ë‹ˆë‹¤!</p>
                    <p class="text-xl font-bold text-slate-800 dark:text-white">
                        {{ session.user_nickname }}ë‹˜
                    </p>
                </div>

                {% if has_postbox %}
                <a href="/postbox/{{ postbox_url }}"
                    class="flex items-center justify-center gap-3 px-6 py-4 bg-primary hover:bg-blue-600 dark:bg-primary dark:hover:bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    <span>ğŸ“® ë‚´ ìš°ì²´í†µìœ¼ë¡œ ê°€ê¸°</span>
                </a>
                {% else %}
                <a href="/create-postbox"
                    class="flex items-center justify-center gap-3 px-6 py-4 bg-primary hover:bg-blue-600 dark:bg-primary dark:hover:bg-blue-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    <span>ğŸ“® ë‚´ ìš°ì²´í†µ ë§Œë“¤ê¸°</span>
                </a>
                {% endif %}
            </div>
            {% else %}
            <!-- ë¡œê·¸ì¸ ë˜ì§€ ì•Šì€ ìƒíƒœ: ë¡œê·¸ì¸ ë²„íŠ¼ ë³´ì—¬ì£¼ê¸° -->
            <button id="google-login-btn"
                class="flex items-center justify-center gap-3 px-4 py-3 bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 rounded-xl transition-all duration-300 shadow-sm hover:shadow-md group">
                <img src="https://www.google.com/favicon.ico" class="w-5 h-5" alt="Google">
                <span class="text-sm font-medium">Googleë¡œ ì‹œì‘í•˜ê¸°</span>
            </button>

            <button id="kakao-login-btn"
                class="flex items-center justify-center gap-3 px-4 py-3 bg-[#FEE500] hover:bg-[#FDE100] text-[#191919] rounded-xl transition-all duration-300 shadow-sm hover:shadow-md">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 3c-4.97 0-9 3.185-9 7.115 0 2.558 1.707 4.8 4.27 6.054-.188.702-.682 2.545-.78 2.922-.123.477.175.47.37.34.152-.102 2.41-1.637 3.393-2.302.544.073 1.103.111 1.677.111 4.97 0 9-3.185 9-7.115S16.97 3 12 3z" />
                </svg>
                <span class="text-sm font-medium">ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // 1. Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (base.htmlì˜ ë³€ìˆ˜ í™œìš©)
    const sbUrl = "{{ supabase_url }}";
    const sbKey = "{{ supabase_key }}";
    const sbClient = supabase.createClient(sbUrl, sbKey);

    // 2. ì¸ì¦ ì„œë¹„ìŠ¤ ë¡œì§
    const authService = {
        async login(provider) {
            // ì‚¬ìš©ìê°€ ì§ì ‘ í´ë¦­í–ˆìŒì„ ì„¸ì…˜ì— ê¸°ë¡ (ê°€ì¥ ì¤‘ìš”!)
            sessionStorage.setItem('manual_login', 'true');

            const { data, error } = await sbClient.auth.signInWithOAuth({
                provider: provider,
                options: {
                    redirectTo: window.location.origin + '/auth/callback'
                }
            });
            if (error) {
                console.error("Login Error:", error.message);
                sessionStorage.removeItem('manual_login');
            }
        }
    };

    // 3. ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²° (DOM ë¡œë“œ í›„)
    document.addEventListener('DOMContentLoaded', () => {
        const googleBtn = document.getElementById('google-login-btn');
        const kakaoBtn = document.getElementById('kakao-login-btn');

        if (googleBtn) googleBtn.onclick = () => authService.login('google');
        if (kakaoBtn) kakaoBtn.onclick = () => authService.login('kakao');
    });

    // 4. ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    (async () => {
        sbClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                // ìˆ˜ë™ ë¡œê·¸ì¸ì´ ì•„ë‹ˆê±°ë‚˜(ì´ì „ ì„¸ì…˜ ìë™ ê°ì§€ ë“±), ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ
                const isManual = sessionStorage.getItem('manual_login');
                const isProcessing = sessionStorage.getItem('auth_processing');

                if (isManual !== 'true' || isProcessing === 'ing') return;

                sessionStorage.setItem('auth_processing', 'ing');

                // êµ¬ê¸€/ì¹´ì¹´ì˜¤ ê³µí†µìœ¼ë¡œ ë‹‰ë„¤ì„ ì¶”ì¶œ
                const metadata = session.user.user_metadata;
                // êµ¬ê¸€ì€ 'full_name', ì¹´ì¹´ì˜¤ëŠ” 'full_name' í˜¹ì€ 'nickname'ì„ ì£¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
                const nickname = metadata.full_name || metadata.nickname || session.user.email.split('@')[0];

                try {
                    const response = await fetch('/auth/check-and-save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: session.access_token,
                            email: metadata.email,
                            nickname: nickname
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        sessionStorage.setItem('auth_processing', 'done');
                        sessionStorage.removeItem('manual_login'); // í”Œë˜ê·¸ ì´ˆê¸°í™”
                        window.location.replace(result.redirect_url);
                    } else {
                        throw new Error(result.message);
                    }
                } catch (err) {
                    console.error("ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:", err);
                    sessionStorage.removeItem('auth_processing');
                    sessionStorage.removeItem('manual_login');
                }
            }
        });
    })();
</script>