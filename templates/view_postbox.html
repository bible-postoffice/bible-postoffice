{% extends 'base.html' %}

{% block content %}
<div class="flex-1 flex flex-col items-center justify-center px-6 py-12 max-w-2xl mx-auto w-full text-center relative">

    {% if is_logged_in %}
    <a href="/logout"
       class="fixed top-16 right-4 z-50 text-sm font-bold px-3 py-1.5 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-700 shadow pointer-events-auto">
        ë¡œê·¸ì•„ì›ƒ
    </a>
    {% endif %}

    <div class="mb-4">
        {# ìš°ì²´í†µ ìƒ‰ìƒë³„ íŒŒìŠ¤í…” ë°°ì§€ í…Œë§ˆ ì •ì˜ #}
        {% set badge_themes = {
        'pink': 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
        'yellow': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
        'blue': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
        'purple': 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
        'green': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
        'red': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
        } %}

        {# ì„ íƒëœ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ slate(íšŒìƒ‰) ì²˜ë¦¬ #}
        {% set theme = badge_themes.get(color, 'bg-slate-100 text-slate-600') %}

        <span id="badge"
            class="px-4 py-1.5 rounded-full text-xs font-bold shadow-sm {{ theme }} inline-flex items-center gap-1.5 border border-white/50 dark:border-white/10">
            {% if privacy == 'public' %}
            <span class="text-sm">ğŸ”“</span> ëª¨ë‘ì—ê²Œ ê³µê°œ
            {% else %}
            <span class="text-sm">ğŸ”’</span> ë‚˜ë§Œ ë³´ê¸°
            {% endif %}
        </span>
    </div>

    <h1 class="text-3xl font-black text-slate-900 dark:text-white mb-8">{{ postbox_name }}</h1>

    <div class="relative mb-10 animate-float">
        <img src="/static/images/postbox/{{ color }}.png" class="w-64 h-64 object-contain drop-shadow-2xl mx-auto">
        <div class="mt-6 text-slate-600 dark:text-slate-300">
            í˜„ì¬ <span class="text-primary font-bold text-2xl">{{ postcard_count }}</span>ê°œì˜ í¸ì§€ê°€ ë‹´ê²¨ìˆì–´ìš”!
        </div>
    </div>

    <div class="w-full max-w-sm">
        {% if is_owner %}
        {% if is_expired %}
        <button onclick="location.href='/inbox/{{ postbox_name }}'"
            class="w-full py-5 bg-accent text-slate-900 rounded-2xl font-bold text-xl shadow-xl hover:scale-[1.02] transition-all">
            ğŸ“© ë„ì°©í•œ ë©”ì‹œì§€ ì½ê¸°
        </button>
        {% else %}
        <div class="bg-slate-100 dark:bg-slate-800 p-6 rounded-3xl border-2 border-dashed border-slate-300">
            <p class="text-sm text-slate-500 mb-3">ë©”ì‹œì§€ ê³µê°œê¹Œì§€ ë‚¨ì€ ì‹œê°„</p>
            <div id="countdown" class="text-3xl font-black tracking-widest text-primary">00:00:00:00</div>
            <p class="mt-4 text-xs text-slate-400 font-medium">
                {# '2026-01-01'ì„ '-' ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ ì„œ ì›”/ì¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ #}
                {% set date_parts = end_date.split('-') %}
                í¸ì§€ëŠ” {{ date_parts[1]|int }}ì›” {{ date_parts[2]|int }}ì¼ì— ì—´ì–´ë³¼ ìˆ˜ ìˆì–´ìš”!
            </p>
        </div>
        {% endif %}

        {% else %}
        <button onclick="checkLoginAndWrite()"
            class="w-full py-5 bg-primary text-white rounded-2xl font-bold text-xl shadow-xl hover:scale-[1.02] transition-all">
            âœï¸ í¸ì§€ ë‚¨ê¸°ê¸°
        </button>
        <p class="mt-4 text-slate-400 text-sm">ì†Œì¤‘í•œ ì‚¬ëŒì—ê²Œ ë”°ëœ»í•œ ë§ˆìŒì„ ì „ë‹¬í•˜ì„¸ìš”.</p>
        {% endif %}
    </div>
</div>

<script>
    // ë§í¬ ì†Œìœ ìì´ê³  ì•„ì§ ì‹œê°„ì´ ì•ˆ ì§€ë‚¬ì„ ë•Œë§Œ ì‹¤í–‰
    {% if is_owner and not is_expired %}
    function updateCountdown() {
        const now = new Date();
        const endDateStr = "{{ end_date }}"; // '2026-01-01'ì´ ë“¤ì–´ì˜´
        const target = new Date(endDateStr + "T00:00:00");
        const diff = target - now;

        if (diff <= 0) {
            location.reload(); // ì‹œê°„ì´ ë‹¤ ë˜ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì„œ 'ë©”ì‹œì§€ ì½ê¸°' ë²„íŠ¼ìœ¼ë¡œ ì „í™˜
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const mins = Math.floor((diff / (1000 * 60)) % 60);
        const secs = Math.floor((diff / 1000) % 60);

        document.getElementById('countdown').innerText =
            `${days}d ${String(hours).padStart(2, '0')}h ${String(mins).padStart(2, '0')}m ${String(secs).padStart(2, '0')}s`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();
    {% endif %}


    function checkLoginAndWrite() {
            // Jinja2 ë³€ìˆ˜ë¥¼ JSì—ì„œ ì‚¬ìš©
        const isLoggedIn = "{{ 'true' if is_logged_in else 'false' }}";
        const urlPath = "{{ url_path }}";
        const color = "{{ color }}";

        if (!isLoggedIn) {
            alert("í¸ì§€ë¥¼ ë‚¨ê¸°ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            // ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì´ ìš°ì²´í†µìœ¼ë¡œ ëŒì•„ì˜¤ë„ë¡ redirect ì„¤ì • (ì„ íƒì‚¬í•­)
            window.location.href = "/login";
        } else {
            // ë¡œê·¸ì¸ ë˜ì–´ ìˆìœ¼ë©´ í¸ì§€ ì‘ì„± í˜ì´ì§€(send_postcard)ë¡œ ì´ë™
            // ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ìš°ì²´í†µ ìƒ‰ìƒì„ ë„˜ê²¨ì£¼ë©´ ì‘ì„± í˜ì´ì§€ ë””ìì¸ì„ ë§ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            window.location.href = `/send_postcard/${urlPath}`;
        }
    }
</script>
{% endblock %}
