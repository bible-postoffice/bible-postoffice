{% extends 'base.html' %}

{% block content %}
<div class="flex-1 flex flex-col items-center justify-center px-6 py-12 max-w-2xl mx-auto w-full text-center relative">

    <div class="mb-4">
        {% if not is_expired %}
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 shadow-sm">
                {{ end_date.year }}ë…„ {{ end_date.month }}ì›” {{ end_date.day }}ì¼ ê°œë´‰ ì˜ˆì • ğŸ”’
            </span>
        {% else %}
            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 shadow-sm animate-bounce">
                ìš°ì²´í†µì´ ê°œë´‰ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’Œ
            </span>
        {% endif %}
    </div>

    <h1 class="text-3xl font-extrabold text-slate-900 mb-2">
        {{ postbox.name }}ë‹˜ì˜ ìš°ì²´í†µ
    </h1>
    
    {% if postbox.prayer_topic %}
    <p class="text-slate-500 text-sm mb-8 bg-white/50 py-2 px-4 rounded-full inline-block border border-slate-100">
        ğŸ™ ê¸°ë„ì œëª©: {{ postbox.prayer_topic }}
    </p>
    {% endif %}

    <div class="w-full mt-6">
        {% if not is_expired %}
            <div class="bg-white/80 backdrop-blur-md border-2 border-dashed border-slate-200 rounded-3xl p-10 shadow-sm mb-8">
                <div class="text-6xl mb-6">ğŸ</div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">ì•„ì§ ìš°ì²´í†µì´ ë‹«í˜€ìˆì–´ìš”</h3>
                <p class="text-slate-600 mb-6">
                    í˜„ì¬ê¹Œì§€ <strong>{{ postcard_count }}í†µ</strong>ì˜ ì†Œì¤‘í•œ ë§ˆìŒì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br>
                    ì§€ì •ëœ ê°œë´‰ì¼ì— ëª¨ë“  í¸ì§€ê°€ ê³µê°œë©ë‹ˆë‹¤.
                </p>
                <!-- <div class="inline-block bg-slate-900 text-white px-6 py-2 rounded-2xl text-sm font-medium">
                    D-Day: {{ end_date.year }}. {{ end_date.month }}. {{ end_date.day }}
                </div> -->
                <div class="bg-white/80 backdrop-blur-md border-2 border-dashed border-slate-200 rounded-3xl p-10 shadow-sm mb-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">â³ ìš°ì²´í†µ ê°œë´‰ê¹Œì§€ ë‚¨ì€ ì‹œê°„</h3>
                    
                    <div id="countdown" class="flex justify-center gap-4 text-slate-900 font-mono text-3xl">
                        <div class="flex flex-col">
                            <span id="days" class="font-black text-blue-600">00</span>
                            <span class="text-xs text-slate-400 font-sans uppercase">Days</span>
                        </div>
                        <span>:</span>
                        <div class="flex flex-col">
                            <span id="hours" class="font-black text-slate-800">00</span>
                            <span class="text-xs text-slate-400 font-sans uppercase">Hrs</span>
                        </div>
                        <span>:</span>
                        <div class="flex flex-col">
                            <span id="minutes" class="font-black text-slate-800">00</span>
                            <span class="text-xs text-slate-400 font-sans uppercase">Min</span>
                        </div>
                        <span>:</span>
                        <div class="flex flex-col">
                            <span id="seconds" class="font-black text-slate-800">00</span>
                            <span class="text-xs text-slate-400 font-sans uppercase">Sec</span>
                        </div>
                    </div>

                    <p class="mt-6 text-sm text-slate-500 font-sans">
                        {{ end_date.year }}ë…„ {{ end_date.month }}ì›” {{ end_date.day }}ì¼ 00:00ì— ìë™ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <a href="/write/{{ postbox.url }}" 
               class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-2xl transition-all shadow-lg hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2">
                <span>âœ¨</span> ë‚˜ë„ ë§ì”€ ì¹´ë“œ ë³´ë‚´ê¸°
            </a>

        {% else %}
            <div class="space-y-4">
                {% if postcards %}
                    <div class="grid grid-cols-1 gap-4">
                        {% for card in postcards %}
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-left transition-transform hover:shadow-md">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-blue-500 bg-blue-50 px-2 py-0.5 rounded">
                                    {{ card.verse_reference }}
                                </span>
                            </div>
                            
                            <p class="text-slate-800 font-semibold text-lg leading-relaxed mb-4">
                                "{{ card.verse_text }}"
                            </p>
                            
                            <div class="bg-slate-50 p-4 rounded-xl">
                                <p class="text-slate-600 text-sm whitespace-pre-wrap leading-relaxed">
                                    {{ card.message }}
                                </p>
                            </div>
                            
                            <p class="text-right text-xs text-slate-400 mt-4 font-medium">
                                From. {{ 'ìµëª…' if card.is_anonymous else card.sender_name }}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="py-20 text-slate-400">
                        <p>ë„ì°©í•œ í¸ì§€ê°€ ì—†ë„¤ìš”. ğŸ˜¢</p>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="mt-12 w-full pt-8 border-t border-slate-100">
        <p class="text-xs text-slate-400 mb-4 uppercase tracking-widest font-bold">Share this box</p>
        <div class="flex gap-3 justify-center">
            <button onclick="copyLink()" class="flex-1 max-w-[160px] bg-white border border-slate-200 text-slate-700 px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                ğŸ”— ë§í¬ ë³µì‚¬
            </button>
            <button onclick="shareKakao()" class="flex-1 max-w-[160px] bg-[#FEE500] text-[#3c1e1e] px-4 py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-[#fada0a] transition-colors flex items-center justify-center gap-2">
                ğŸ’¬ ì¹´í†¡ ê³µìœ 
            </button>
        </div>
    </div>
</div>

<script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
<script>
  // ì´ ë¶€ë¶„ì— ë³µì‚¬í•œ JavaScript í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš” (ë°©ê¸ˆ ì£¼ì‹  ê¸´ JWT í† í°ì´ ì•„ë‹™ë‹ˆë‹¤!)
  if (!Kakao.isInitialized()) {
    Kakao.init('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNidXpyb2d1c2ljeHV2Z3dwcXp3Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTc0MjkwMCwiZXhwIjoyMDgxMzE4OTAwfQ.15Bjqn1m6AsYS_YUK0Y_e72ZLNY9GbCrVSx1JOre3Bk'); 
  }
</script>
<script>
const targetDate = {{ target_timestamp or 0 }};
    // ì¸í„°ë²Œ ë³€ìˆ˜ë¥¼ ë°–ì—ì„œ ì„ ì–¸í•´ì•¼ í•¨ìˆ˜ ì•ˆì—ì„œ ë©ˆì¶œ(clearInterval) ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    let timerInterval = null;

    function updateCountdown() {
        if (targetDate === 0) return;

        const now = new Date().getTime();
        const distance = targetDate - now;

        const countdownEl = document.getElementById('countdown');
        if (!countdownEl) return;

        // ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œ
        if (distance <= 0) {
            if (timerInterval) clearInterval(timerInterval);
            
            // UIë¥¼ 00:00:00ìœ¼ë¡œ ê³ ì •
            document.querySelectorAll('#countdown span[id]').forEach(el => el.innerText = '00');
            
            // ì„œë²„ì—ì„œ ì•„ì§ ë¯¸ë§Œë£Œë¼ê³  íŒë‹¨í–ˆì„ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨
            {% if not is_expired %}
            console.log("Countdown finished! Reloading...");
            location.reload();
            {% endif %}
            return;
        }

        // ì‹œê°„ ê³„ì‚°
        const d = Math.floor(distance / (1000 * 60 * 60 * 24));
        const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((distance % (1000 * 60)) / 1000);

        // ì—˜ë¦¬ë¨¼íŠ¸ ì¡´ì¬ í™•ì¸ í›„ ì•ˆì „í•˜ê²Œ ë°˜ì˜
        const daysEl = document.getElementById('days');
        const hoursEl = document.getElementById('hours');
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');

        if (daysEl) daysEl.innerText = String(d).padStart(2, '0');
        if (hoursEl) hoursEl.innerText = String(h).padStart(2, '0');
        if (minutesEl) minutesEl.innerText = String(m).padStart(2, '0');
        if (secondsEl) secondsEl.innerText = String(s).padStart(2, '0');
    }

    // ì‹¤í–‰ ë¡œì§ í•˜ë‚˜ë¡œ í†µí•©
    if (targetDate > 0) {
        updateCountdown(); // ì¦‰ì‹œ ì‹¤í–‰
        timerInterval = setInterval(updateCountdown, 1000); // 1ì´ˆë§ˆë‹¤ ë°˜ë³µ
    }
</script>
<script>
    // URL ë³µì‚¬ í•¨ìˆ˜
    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert("ìš°ì²´í†µ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”.");
        });
    }

    // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  (JS Key ì„¤ì • í•„ìš”)
    function shareKakao() {
         // 1. Kakao ê°ì²´ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (typeof Kakao === 'undefined') {
            alert("ì¹´ì¹´ì˜¤ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        // 2. ì´ˆê¸°í™” í™•ì¸ (ë³¸ì¸ì˜ JS í‚¤ê°€ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•¨)
        if (!Kakao.isInitialized()) {
            alert("ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        // 3. ìµœì‹  ë°©ì‹ì¸ Kakao.Share.sendDefault ì‚¬ìš©
        // ë§Œì•½ Shareë„ ì•ˆëœë‹¤ë©´ Kakao.Link.sendDefaultë¡œ ì‹œë„
        const shareTarget = Kakao.Share || Kakao.Link;

        if (shareTarget && shareTarget.sendDefault) {
            shareTarget.sendDefault({
                objectType: 'feed',
                content: {
                    title: '{{ postbox.name }}ë‹˜ì˜ ë§ì”€ ìš°ì²´í†µ',
                    description: '{{ end_date.year }}ë…„ {{ end_date.month }}ì›” {{ end_date.day }}ì¼ì— ì—´ë¦¬ëŠ” ìš°ì²´í†µì— ë§ˆìŒì„ ë‚¨ê²¨ì£¼ì„¸ìš”!',
                    imageUrl: 'https://your-service-domain.com/static/images/og_image.png', // ì‹¤ì œ ì´ë¯¸ì§€ ì£¼ì†Œ í•„ìš”
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                },
                buttons: [{
                    title: 'í¸ì§€ ì“°ëŸ¬ ê°€ê¸°',
                    link: {
                        mobileWebUrl: window.location.href,
                        webUrl: window.location.href,
                    },
                }],
            });
        } else {
            alert("ì¹´ì¹´ì˜¤ ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.");
        }
    }
</script>
{% endblock %}