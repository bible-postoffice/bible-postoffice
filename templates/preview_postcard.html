<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎØ∏Î¶¨Î≥¥Í∏∞ & Í∏ÄÏî®Ï≤¥</title>
    <style>
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Thin.woff2') format('woff2');
            font-weight: 100;
            font-display: swap;
}

        @font-face {
            font-family: 'PyeojinGothic';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2504-1@1.0/PyeojinGothic-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'KimJeongcheolMyoungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/KimjungchulMyungjo-Light.woff2') format('woff2');
            font-weight: 300;
            font-display: swap;
        }
        @font-face {
            font-family: 'YesMyungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_13@1.0/YESMyoungjo-Regular.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SchoolSafetyWing';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/HakgyoansimNalgaeR.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        :root {
            --ink: #0f172a;
            --muted: #6b7280;
            --accent: #6366f1;
            --panel: #ffffff;
            --bg: #f5f7fb;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Pretendard', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--ink);
            padding: 28px 16px 34px;
        }
        .shell {
            max-width: 1180px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 50px rgba(15,23,42,0.08);
            padding: 26px 24px 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            gap: 14px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        h2 {
            margin: 0;
            font-size: 28px;
            letter-spacing: -0.02em;
            font-family: 'Noto Serif KR', 'Pretendard', serif;
        }
        .sub {
            margin-top: 6px;
            color: var(--muted);
        }
        
        .layout {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 18px;
            margin-top: 22px;
            width: 100%;
        }
        .layout > * { min-width: 0; }
        .preview-card {
            position: relative;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            min-height: 0;
        }
        .template-frame {
            position: relative;
            width: 100%;
            min-height: 360px;
            background-size: cover;
            background-position: center;
            border-radius: 16px;
            border: 1px solid #d1d5db;
            overflow: hidden;
            box-shadow: 0 18px 36px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
            box-sizing: border-box;
        }
        .template-frame.postcard { aspect-ratio: 16 / 10; }
        .template-frame.letter { aspect-ratio: 2 / 3; }
        
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
        }
        
        /* ÏóΩÏÑú ÌÖúÌîåÎ¶ø: ÏúÑÏïÑÎûò 1Îã® Íµ¨Ï°∞ */
        .template-frame.postcard .overlay { 
            display: grid;
            grid-template-rows: 60% 40%;
            gap: 0;
            padding: 12% 6% 6%;
            justify-content: space-between;
        }
        
        .template-frame.postcard .left,
        .template-frame.postcard .right {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            min-height: 0;
        }
        .template-frame.postcard .left {
            padding-top: 0;
        }
        
        .verse-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1 1 auto;
            max-height: none;
            justify-content: flex-start;
        }
        .verse-box .text {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .verse-box .ref {
            font-weight: 800;
            text-align: right;
            flex-shrink: 0;
            margin-top: 0.3em;
            align-self: flex-end;
            display: block;
            color: var(--ink);
            font-size: 13px;
        }
        .msg-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .msg-box .body {
            flex: 1;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        .sender-box {
            color: var(--ink);
            font-weight: 700;
            overflow: hidden;
            width: 100%;
            text-align: center;
            align-self: center;
        }
        
        .template-frame.postcard .verse-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
            min-height: 0;
        }
        
        .template-frame.postcard .msg-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
            min-height: 0;
        }
        
        .template-frame.postcard .sender-box {
            margin-top: auto;
            background: none;
            border: none;
            box-shadow: none;
            flex: 0 0 12.5%;
            padding-top: 2px;
            padding-bottom: 2px;
            line-height: 1.2;
            overflow: visible;
        }
        .template-frame.postcard .msg-box {
            flex: 0 0 87.5%;
        }
        
        /* Ìé∏ÏßÄÏßÄ ÌÖúÌîåÎ¶ø: ÏÑ∏Î°ú Î∞∞Ïπò */
        .template-frame.letter .overlay {
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 6%;
            padding: 10% 8%;
            height: 80%;
            margin: auto;
        }
        .template-frame.letter .left,
        .template-frame.letter .right {
            width: 80%;
            max-width: 760px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .template-frame.letter .left {
            flex: 0 0 40%;
            justify-content: center;
        }
        .template-frame.letter .right {
            flex: 0 0 40%;
            justify-content: flex-start;
            gap: 8px;
        }
        
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box,
        .template-frame.letter .sender-box {
            background: none;
            border: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box {
            width: 100%;
            max-width: 760px;
        }
        .template-frame.letter .msg-box {
            flex: 1 1 0;
            min-height: 0;
            overflow: auto;
            height: 100%;
        }
        .template-frame.letter .msg-box .body {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .template-frame.letter .sender-box {
            width: 100%;
            max-width: 760px;
            border-radius: 0;
            align-self: center;
            text-align: center;
            margin-top: auto;
        }
        
        .side {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .font-section {
            flex: 1 1 auto;
        }
        .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .font-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .font-tab {
            border: 1px solid #d1d5db;
            border-radius: 999px;
            padding: 8px 12px;
            background: #fff;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: border 0.15s ease, box-shadow 0.15s ease;
        }
        .font-tab.active {
            border-color: #6366f1;
            box-shadow: 0 8px 16px rgba(79,70,229,0.2);
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
        }
        .font-option {
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fff;
            cursor: pointer;
            transition: border 0.15s ease, box-shadow 0.15s ease;
        }
        .font-option:hover {
            border-color: #94a3b8;
            box-shadow: 0 10px 20px rgba(0,0,0,0.06);
        }
        .font-option.active {
            border-color: #6366f1;
            box-shadow: 0 14px 28px rgba(79,70,229,0.16);
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
        }
        .font-label {
            font-weight: 800;
            color: #0f172a;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: auto;
        }
        button {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-weight: 800;
            cursor: pointer;
            font-size: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2b59ff 0%, #6c8bff 100%);
            color: #fff;
            border: none;
            box-shadow: 0 12px 24px rgba(59,130,246,0.25);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .tag {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4338ca;
            font-weight: 700;
            font-size: 12px;
            margin-left: 6px;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 540px) {
            body { padding: 14px 12px 18px; }
            .shell { padding: 16px 12px 20px; border-radius: 14px; }
            .header { flex-direction: column; gap: 10px; }
            
            .preview-card { width: 100%; }
            .template-frame { min-height: 240px; border-radius: 12px; width: 100%; max-width: 100%; margin: 0 auto; }
            .template-frame.postcard {
                background-size: contain;
                background-repeat: no-repeat;
            }
            .template-frame.postcard .overlay { 
                display: grid;
                grid-template-rows: 60% 40%;
                gap: 0; 
                padding: 14% 7% 10%; 
                justify-content: space-between;
            }
            .template-frame.postcard .left,
            .template-frame.postcard .right {
                padding-top: 0;
                gap: 8px;
                flex: 1 1 auto;
                width: 100%;
                min-height: 0;
            }
            .verse-box,
            .msg-box { font-size: 13px; word-break: break-word; }
            .verse-box .ref { font-size: 11px; }
            .side { padding: 12px; border-radius: 12px; }
            .font-tabs { flex-wrap: nowrap; }
            .font-tab { flex: 1 1 0; text-align: center; padding: 8px 6px; }
            .font-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; gap: 8px; }
            button { width: 100%; }
            /* Ìé∏ÏßÄÏßÄ Î™®ÎìúÏóêÏÑú Ï§ëÏïô 80% ÏòÅÏó≠Ïóê ÌÖçÏä§Ìä∏ Î∞∞Ïπò */
            .template-frame.letter .overlay {
                padding: 8% 6%;
                gap: 6%;
                justify-content: space-between;
            }
            .template-frame.letter .verse-box {
                min-height: 40%;
                display: flex;
                align-items: center;
            }
            .template-frame.letter .msg-box,
            .template-frame.letter .sender-box {
                max-width: none;
            }
            .template-frame.letter .msg-box {
                min-height: 0;
            }
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="header">
            <div>
                <h2>Ï†ÑÏÜ° Ï†Ñ ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
                <div class="sub">ÏÑ†ÌÉùÌïú ÎßêÏîÄÍ≥º Ìé∏ÏßÄÎ•º ÏõêÌïòÎäî Í∏ÄÏî®Ï≤¥Î°ú ÌôïÏù∏ÌïòÍ≥† Î≥¥ÎÇ¥Ï£ºÏÑ∏Ïöî.</div>
            </div>
            
        </div>

        <div class="layout">
            <div class="preview-card">
                <div class="template-frame postcard" id="template-frame">
                    <div class="overlay">
                        <div class="left">
                            <div class="verse-box">
                                <div class="text" id="verse-text"></div>
                                <span class="ref" id="verse-ref"></span>
                            </div>
                        </div>
                        <div class="right">
                            <div class="msg-box">
                                <div class="body" id="message-text"></div>
                            </div>
                            <div class="sender-box">
                                From. <span id="sender-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side">
                

                <div class="font-section">
                    <div style="font-weight:800; margin-bottom:8px; color:#0f172a;">Í∏ÄÏî®Ï≤¥ ÏÑ†ÌÉù</div>
                    <div class="font-tabs" id="font-tabs"></div>
                    <div class="font-grid" id="font-grid"></div>
                </div>

                <div class="actions">
                    <button id="edit-btn">ÏàòÏ†ïÌïòÍ∏∞</button>
                    <button class="btn-primary" id="send-btn">Ïù¥ÎåÄÎ°ú Î≥¥ÎÇºÍ≤åÏöî üöÄ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const postboxId = "{{ postbox_id }}";
        const draftKey = `postcardDraft-${postboxId}`;
        const returnKey = `postboxReturnUrl-${postboxId}`;
        const templateAssets = {
            1: "{{ url_for('static', filename='images/postcards/postcard1.jpg') }}",
            2: "{{ url_for('static', filename='images/postcards/postcard2.jpg') }}",
            3: "{{ url_for('static', filename='images/postcards/postcard3.jpg') }}",
            4: "{{ url_for('static', filename='images/postcards/postcard4.jpg') }}",
            5: "{{ url_for('static', filename='images/postcards/postcard5.jpg') }}",
            6: "{{ url_for('static', filename='images/postcards/postcard6.jpg') }}",
            7: "{{ url_for('static', filename='images/postcards/postcard7.jpg') }}",
            8: "{{ url_for('static', filename='images/postcards/postcard8.jpg') }}",
            9: "{{ url_for('static', filename='images/postcards/postcard9.jpg') }}",
        };
        const FONT_OPTIONS = {
            'sans': {
                id: 'sans',
                label: 'Î™®Îçò ÏÇ∞ÏÑ∏Î¶¨ÌîÑ',
                desc: 'ÍπîÎÅîÌïòÍ≥† Îã®Ï†ïÌïú Î∂ÑÏúÑÍ∏∞',
                fontFamily: "'Pretendard','Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif",
                sample: 'Îäò ÌèâÏïàÍ≥º ÏùÄÌòúÍ∞Ä Ìï®ÍªòÌïòÍ∏∏ Î∞îÎùºÏöî.'
            },
            'serif': {
                id: 'serif',
                label: 'ÌÅ¥ÎûòÏãù ÏÑ∏Î¶¨ÌîÑ',
                desc: 'Ï†ÑÌÜµÏ†ÅÏù∏ Ìé∏ÏßÄ ÎäêÎÇå',
                fontFamily: "'Noto Serif KR','Times New Roman','Apple SD Gothic Neo',serif",
                sample: 'Í∏∞ÎèÑÎ°ú Ìï®ÍªòÌïòÎ©∞ ÏùëÏõêÌï†Í≤åÏöî.'
            },
            'hand': {
                id: 'hand',
                label: 'Îî∞ÎúªÌïú ÏÜêÍ∏ÄÏî®',
                desc: 'ÏπúÍ∑ºÌïú ÌïÑÍ∏∞Ï≤¥ ÎäêÎÇå',
                fontFamily: "'Nanum Pen Script','Comic Sans MS','Apple SD Gothic Neo',cursive",
                sample: 'ÎßàÏùå Í∞ÄÎìù ÏÇ¨ÎûëÏùÑ Îã¥ÏïòÏñ¥Ïöî.'
            },
            'pyeojin': {
                id: 'pyeojin',
                label: 'Ìé¥ÏßÑÍ≥†Îîï',
                desc: 'Îë•Í∏ÄÎë•Í∏ÄÌïú Í≥†ÎîïÏ≤¥',
                fontFamily: "'PyeojinGothic','Noto Sans KR','Apple SD Gothic Neo',sans-serif",
                sample: 'Îî∞ÎúªÌïòÍ≤å ÎßàÏùåÏùÑ Ï†ÑÌï¥Ïöî.'
            },
            'kimmyoungjo': {
                id: 'kimmyoungjo',
                label: 'ÍπÄÏ†ïÏ≤† Î™ÖÏ°∞',
                desc: 'ÏñáÍ≥† Ïö∞ÏïÑÌïú Î™ÖÏ°∞',
                fontFamily: "'KimJeongcheolMyoungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ÏùÄÌòúÏôÄ ÌèâÍ∞ïÏù¥ Í∞ÄÎìùÌïòÍ∏∏.'
            },
            'yesmyungjo': {
                id: 'yesmyungjo',
                label: 'ÏòàÏä§ Î™ÖÏ°∞',
                desc: 'ÏÑ†Î™ÖÌïú Ï†ÑÌÜµ Î™ÖÏ°∞',
                fontFamily: "'YesMyungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ÏßÑÏã¨ÏùÑ Îã¥ÏïÑ ÏùëÏõêÌï¥Ïöî.'
            },
            'schoolsafety': {
                id: 'schoolsafety',
                label: 'ÌïôÍµêÏïàÏ†ÑÎÇ†Í∞ú',
                desc: 'Îë•Í∏ÄÍ≥† Í∑ÄÏó¨Ïö¥ ÏÜêÍ∏ÄÏî® ÎäêÎÇå',
                fontFamily: "'SchoolSafetyWing','Noto Sans KR','Apple SD Gothic Neo',cursive",
                sample: 'ÎßàÏùå Í∞ÄÎìù ÏùëÏõêÍ≥º ÏÇ¨ÎûëÏùÑ Îã¥ÏïòÏñ¥Ïöî.'
            }
        };

        const frameEl = document.getElementById('template-frame');
        const overlayEl = document.querySelector('.template-frame .overlay');
        const verseRefEl = document.getElementById('verse-ref');
        const verseTextEl = document.getElementById('verse-text');
        const messageTextEl = document.getElementById('message-text');
        const senderLabelEl = document.getElementById('sender-label');
        const fontTabsEl = document.getElementById('font-tabs');
        const fontGridEl = document.getElementById('font-grid');
        const sendBtn = document.getElementById('send-btn');
        const editBtn = document.getElementById('edit-btn');

        let draft = null;
        let selectedFont = 'serif';
        let activeFontCategory = 'sans';
        let templateImageSize = null;
        const FONT_CATEGORIES = [
            { id: 'sans', label: 'Í≥†Îîï' },
            { id: 'serif', label: 'Î™ÖÏ°∞' },
            { id: 'hand', label: 'ÏÜêÍ∏ÄÏî®' }
        ];
        const SERIF_FONT_IDS = ['serif', 'kimmyoungjo', 'yesmyungjo'];

        function normalizeTemplate(tpl = {}) {
            const rawId = tpl.id;
            let id = parseInt(String(rawId || '').replace(/\\D+/g, ''), 10);
            if (!id) id = 1;
            const rawType = tpl.type;
            let typeInt = 0;
            if (typeof rawType === 'string') {
                const num = parseInt(rawType, 10);
                if (!Number.isNaN(num)) typeInt = num;
                else typeInt = rawType === 'Ìé∏ÏßÄÏßÄ' ? 1 : 0;
            } else {
                typeInt = rawType ?? 0;
            }
            typeInt = typeInt === 1 ? 1 : 0;
            return {
                id,
                type: typeInt,
                typeLabel: typeInt === 1 ? 'Ìé∏ÏßÄÏßÄ' : 'ÏóΩÏÑú',
                name: tpl.name || `ÌÖúÌîåÎ¶ø ${id}`
            };
        }

        function renderFontTabs() {
            fontTabsEl.innerHTML = '';
            FONT_CATEGORIES.forEach(category => {
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'font-tab' + (category.id === activeFontCategory ? ' active' : '');
                tab.textContent = category.label;
                tab.onclick = () => {
                    activeFontCategory = category.id;
                    renderFontTabs();
                    renderFontOptions();
                };
                fontTabsEl.appendChild(tab);
            });
        }

        function renderFontOptions() {
            fontGridEl.innerHTML = '';
            const filtered = Object.values(FONT_OPTIONS).filter(opt => {
                if (activeFontCategory === 'sans') return ['sans', 'pyeojin'].includes(opt.id);
                if (activeFontCategory === 'serif') return SERIF_FONT_IDS.includes(opt.id);
                if (activeFontCategory === 'hand') return ['hand', 'schoolsafety'].includes(opt.id);
                return true;
            });
            filtered.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'font-option';
                card.dataset.id = opt.id;
                card.innerHTML = `
                    <div class="font-label" style="font-family:${opt.fontFamily}">${opt.label}</div>
                    <div style="color:#6b7280; font-size:13px; margin-top:2px;">${opt.desc}</div>
                `;
                card.onclick = () => selectFont(opt.id);
                fontGridEl.appendChild(card);
            });
        }

        function selectFont(id) {
            const opt = FONT_OPTIONS[id] || FONT_OPTIONS.sans;
            selectedFont = opt.id;
            [messageTextEl, verseTextEl, verseRefEl, senderLabelEl].forEach(el => {
                el.style.fontFamily = opt.fontFamily;
            });
            document.querySelectorAll('.font-option').forEach(card => {
                card.classList.toggle('active', card.dataset.id === selectedFont);
            });
            
            // Ìè∞Ìä∏ Î≥ÄÍ≤Ω ÌõÑ ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ïû¨Ï°∞Ï†ï
            setTimeout(adjustAllText, 50);
            
            persistDraft();
        }


        function applyTemplate() {
            const tpl = normalizeTemplate(draft.template || {});
            const img = templateAssets[tpl.id];
            frameEl.style.backgroundImage = img ? `url(${img})` : '';
            frameEl.classList.remove('postcard', 'letter');
            frameEl.classList.add(tpl.type === 1 ? 'letter' : 'postcard');

            if (img) {
                const image = new Image();
                image.onload = () => {
                    templateImageSize = { width: image.naturalWidth, height: image.naturalHeight };
                    updateOverlayInset();
                };
                image.onerror = () => {
                    templateImageSize = null;
                    updateOverlayInset();
                };
                image.src = img;
            } else {
                templateImageSize = null;
                updateOverlayInset();
            }
        }

        function applyContent() {
            const verse = draft.verse || {};
            const normalizeLineBreaks = (value) => (value || '')
                .replace(/\r\n/g, '\n')
                .replace(/\n\s*\n+/g, '\n');
            verseRefEl.textContent = verse.reference || 'ÏÑ†ÌÉùÌïú ÎßêÏîÄ';
            verseTextEl.textContent = normalizeLineBreaks(verse.text || '');
            messageTextEl.textContent = normalizeLineBreaks(draft.message ? draft.message : '');
            const senderName = (draft.sender_name || '').trim();
            const displayName = senderName || 'ÏùµÎ™Ö';
            senderLabelEl.textContent = displayName;

            setTimeout(updateOverlayInset, 60);
            setTimeout(adjustAllText, 100);
        }

        function persistDraft() {
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            try {
                const next = Object.assign({}, draft, {
                    font_family: opt.fontFamily,
                    font_style: opt.id
                });
                sessionStorage.setItem(draftKey, JSON.stringify(next));
            } catch (e) {
                console.warn('draft persist failed', e);
            }
        }

        function loadDraft() {
            try {
                const raw = sessionStorage.getItem(draftKey);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('draft parse failed', e);
                return null;
            }
        }

        async function sendPostcard() {
            if (!draft || !draft.verse) {
                alert('ÏûëÏÑ± Ï§ëÏù∏ Ìé∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const tpl = normalizeTemplate(draft.template || {});
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Ï†ÑÏÜ° Ï§ë...';
            try {
                const response = await fetch('/api/send-postcard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postbox_id: postboxId,
                        template_id: tpl.id,
                        template_type: tpl.type,
                        template_name: tpl.name,
                        sender_name: (draft.sender_name || '').trim(),
                        is_anonymous: !(draft.sender_name || '').trim(),
                        verse_reference: draft.verse.reference,
                        verse_text: draft.verse.text,
                        message: draft.message || '',
                        font_family: opt.fontFamily,
                        font_style: opt.id
                    })
                });
                if (response.ok) {
                    sessionStorage.removeItem(draftKey);
                    const returnUrl = sessionStorage.getItem(returnKey);
                    sessionStorage.removeItem(returnKey);
                    alert('ÏóΩÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! üéâ\\n2026ÎÖÑ 1Ïõî 1ÏùºÏóê ÏÉÅÎåÄÎ∞©Ïù¥ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                    window.location.href = returnUrl || '/';
                } else {
                    const err = await response.text();
                    alert('Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\\n' + err);
                }
            } catch (e) {
                alert('Ï†ÑÏÜ° Ïã§Ìå®: ' + e.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Ïù¥ÎåÄÎ°ú Î≥¥ÎÇºÍ≤åÏöî üöÄ';
            }
        }
        // ========== ÌÖçÏä§Ìä∏ ÏûêÎèô ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï®Ïàò ==========
        function fitTextToContainer(element, minSize, maxSize, containerHeight = null, containerWidth = null) {
            if (!element || !element.textContent.trim()) return;
            
            let fontSize = maxSize;
            element.style.fontSize = fontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Í∞Ä ÏßÄÏ†ïÎêú Í≤ΩÏö∞ Ìï¥Îãπ ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú, ÏïÑÎãàÎ©¥ ÏöîÏÜå ÏûêÏ≤¥Ïùò ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú
            const refHeight = containerHeight !== null ? containerHeight : element.clientHeight;
            const refWidth = containerWidth !== null ? containerWidth : element.clientWidth;
            
            while ((element.scrollHeight > refHeight + 1 || 
                    element.scrollWidth > refWidth + 1) && 
                fontSize > minSize && iterations < maxIterations) {
                fontSize -= 0.3;
                element.style.fontSize = fontSize + 'px';
                iterations++;
            }
        }

        function fitTextToContainerFill(element, minSize, maxSize, containerHeight = null, containerWidth = null) {
            if (!element || !element.textContent.trim()) return;

            const refHeight = containerHeight !== null ? containerHeight : element.clientHeight;
            const refWidth = containerWidth !== null ? containerWidth : element.clientWidth;
            let fontSize = minSize;
            element.style.fontSize = fontSize + 'px';

            let iterations = 0;
            const maxIterations = 200;
            while (fontSize < maxSize && iterations < maxIterations) {
                element.style.fontSize = (fontSize + 0.3) + 'px';
                if (element.scrollHeight > refHeight + 1 || element.scrollWidth > refWidth + 1) {
                    element.style.fontSize = fontSize + 'px';
                    break;
                }
                fontSize += 0.3;
                iterations++;
            }
        }

        function fitVerseBox() {
            const verseBox = document.querySelector('.verse-box');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            if (!verseBox || !verseRef || !verseText) return;
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            
            let refMin, refMax, textMin, textMax;
            
            if (isMobile) {
                refMin = 8; refMax = 10;
                textMin = 8; textMax = 12;
            } else if (isTablet) {
                refMin = 8; refMax = 15;
                textMin = 7; textMax = 16;
            } else {
                refMin = 12; refMax = 20;
                textMin = 13; textMax = 24;
            }
            
            // Ï†úÎ™©(ref)ÏùÑ Î®ºÏ†Ä ÎßûÏ∂§
            fitTextToContainer(verseRef, refMin, refMax);
            
            // Ï†úÎ™©Ïù¥ Ï∞®ÏßÄÌïú Í≥µÍ∞ÑÏùÑ Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄÏóê Î≥∏Î¨∏ ÎßûÏ∂§
            const verseBoxHeight = verseBox.clientHeight;
            const refHeight = verseRef.offsetHeight;
            const refMargin = parseInt(getComputedStyle(verseRef).marginTop || 0);
            const availableHeight = verseBoxHeight - refHeight - refMargin;
            
            let textFontSize = textMax;
            verseText.style.fontSize = textFontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            while ((verseText.scrollHeight > availableHeight + 1 || 
                    verseText.scrollWidth > verseText.clientWidth + 1) && 
                textFontSize > textMin && iterations < maxIterations) {
                textFontSize -= 0.3;
                verseText.style.fontSize = textFontSize + 'px';
                iterations++;
            }
        }

        function adjustAllText() {
            const msgBoxContainer = document.querySelector('.msg-box');
            const msgBox = document.getElementById('message-text');
            const senderBoxContainer = document.querySelector('.sender-box');
            const senderBox = document.getElementById('sender-label');
            const rightColumn = document.querySelector('.template-frame.postcard .right');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            let msgMin, msgMax, senderMin, senderMax;
            if (isMobile) {
                msgMin = 12; msgMax = 18;
                senderMin = 10; senderMax = 14;
            } else if (isTablet) {
                msgMin = 15; msgMax = 20;
                senderMin = 10; senderMax = 16;
            } else {
                msgMin = 16; msgMax = 28;
                senderMin = 15; senderMax = 18;
            }
            
            // ÏÑ±Í≤Ω Íµ¨Ï†à ÏòÅÏó≠ (Ï†úÎ™© + Î≥∏Î¨∏)
            fitVerseBox();
            if (verseRef && verseText) {
                // ref ÌÅ¨Í∏∞Î•º Î≥∏Î¨∏Í≥º ÎèôÏùºÌïòÍ≤å ÎßûÏ∂§
                verseRef.style.fontSize = getComputedStyle(verseText).fontSize;
            }
            
            // Î©îÏãúÏßÄ ÏòÅÏó≠
            if (msgBox && msgBoxContainer) {
                // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú Ï°∞Ï†à
                fitTextToContainer(msgBox, msgMin, msgMax, msgBoxContainer.clientHeight, msgBoxContainer.clientWidth);

                // Ïó¨Ï†ÑÌûà ÎÑòÏπòÎ©¥ Îçî Ï∂ïÏÜå
                if (msgBox.scrollHeight > msgBoxContainer.clientHeight + 1) {
                    const hardMin = msgMin;
                    const currentSize = parseFloat(getComputedStyle(msgBox).fontSize) || msgMax;
                    fitTextToContainer(msgBox, hardMin, currentSize, msgBoxContainer.clientHeight, msgBoxContainer.clientWidth);
                }
            }
            if (senderBox && msgBox) {
                // Î∞úÏã†Ïûê ÌÅ¨Í∏∞Î•º Î≥∏Î¨∏Î≥¥Îã§ Ï°∞Í∏à ÏûëÍ≤å ÎßûÏ∂§
                const baseSize = getComputedStyle(msgBox).fontSize;
                const baseSizeNum = parseFloat(baseSize) || 0;
                const senderSize = baseSizeNum ? Math.max(baseSizeNum, senderMin) + 'px' : baseSize;
                senderBox.style.fontSize = senderSize;
                const wrapper = senderBox.parentElement;
                if (wrapper) wrapper.style.fontSize = senderSize;
            }
            
            // Î∞úÏã†Ïûê ÏòÅÏó≠
            if (senderBox && senderBoxContainer) {
                // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú Ï°∞Ï†à
                fitTextToContainer(senderBox, senderMin, senderMax, senderBoxContainer.clientHeight, senderBoxContainer.clientWidth);
            }

            // Î™®Î∞îÏùºÏóêÏÑú Î©îÏãúÏßÄ+Î∞úÏã†Ïûê Ìï©Í≥ÑÍ∞Ä ÎÑòÏπòÎäî Í≤ΩÏö∞ Ìï®Íªò Ï∂ïÏÜå
            if (rightColumn && msgBox && senderBox) {
                let msgSize = parseFloat(getComputedStyle(msgBox).fontSize) || msgMin;
                let senderSize = parseFloat(getComputedStyle(senderBox).fontSize) || senderMin;
                let iterations = 0;
                const maxIterations = 200;
                while (rightColumn.scrollHeight > rightColumn.clientHeight + 1 &&
                    iterations < maxIterations) {
                    if (msgSize > msgMin) {
                        msgSize -= 0.3;
                        msgBox.style.fontSize = msgSize + 'px';
                    } else if (senderSize > senderMin) {
                        senderSize -= 0.3;
                        senderBox.style.fontSize = senderSize + 'px';
                        const wrapper = senderBox.parentElement;
                        if (wrapper) wrapper.style.fontSize = senderSize + 'px';
                    } else {
                        break;
                    }
                    iterations++;
                }
            }
        }

        function updateOverlayInset() {
            if (!frameEl || !overlayEl || !frameEl.classList.contains('postcard')) {
                return;
            }
            const style = getComputedStyle(frameEl);
            const bgSize = style.backgroundSize;
            const frameW = frameEl.clientWidth;
            const frameH = frameEl.clientHeight;
            let bgW = 0;
            let bgH = 0;

            if (templateImageSize && templateImageSize.width && templateImageSize.height) {
                const scale = Math.min(frameW / templateImageSize.width, frameH / templateImageSize.height);
                bgW = templateImageSize.width * scale;
                bgH = templateImageSize.height * scale;
            } else if (bgSize && bgSize !== 'cover' && bgSize !== 'auto' && bgSize !== 'auto auto') {
                const parts = bgSize.split(' ');
                if (parts.length >= 2 && parts[0].includes('px') && parts[1].includes('px')) {
                    bgW = parseFloat(parts[0]) || 0;
                    bgH = parseFloat(parts[1]) || 0;
                }
            }

            if (!bgW || !bgH) {
                overlayEl.style.inset = '0px';
                return;
            }

            const insetX = Math.max((frameW - bgW) / 2, 0);
            const insetY = Math.max((frameH - bgH) / 2, 0);
            overlayEl.style.inset = `${insetY}px ${insetX}px`;
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Î∞è Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Ïã§Ìñâ
        window.addEventListener('load', () => {
            updateOverlayInset();
            setTimeout(adjustAllText, 100);
        });
        window.addEventListener('resize', () => {
            updateOverlayInset();
            adjustAllText();
        });

        function init() {
            draft = loadDraft();
            if (!draft || !draft.verse) {
                alert('ÏûëÏÑ± Ï§ëÏù∏ Ìé∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏûëÏÑ± ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
                window.location.href = `/send/${postboxId}/write`;
                return;
            }
            renderFontTabs();
            renderFontOptions();
            applyTemplate();
            applyContent();

            let initialFont = draft.font_style;
            if (!initialFont && draft.font_family) {
                const hit = Object.values(FONT_OPTIONS).find(opt => opt.fontFamily === draft.font_family);
                if (hit) initialFont = hit.id;
            }
            selectedFont = FONT_OPTIONS[initialFont] ? initialFont : 'serif';
            selectFont(selectedFont);
        }

        sendBtn.addEventListener('click', sendPostcard);
        editBtn.addEventListener('click', () => window.location.href = `/send/${postboxId}/write`);
        init();

    </script>
</body>
</html>
