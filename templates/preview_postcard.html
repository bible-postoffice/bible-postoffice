<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë¦¬ë³´ê¸° & ê¸€ì”¨ì²´</title>
    <style>
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Thin.woff2') format('woff2');
            font-weight: 100;
            font-display: swap;
}

        @font-face {
            font-family: 'PyeojinGothic';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2504-1@1.0/PyeojinGothic-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'KimJeongcheolMyoungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/KimjungchulMyungjo-Light.woff2') format('woff2');
            font-weight: 300;
            font-display: swap;
        }
        @font-face {
            font-family: 'YesMyungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_13@1.0/YESMyoungjo-Regular.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SchoolSafetyWing';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/HakgyoansimNalgaeR.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        :root {
            --ink: #0f172a;
            --muted: #6b7280;
            --accent: #6366f1;
            --panel: #ffffff;
            --bg: #f5f7fb;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Pretendard', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--ink);
            padding: 28px 16px 34px;
        }
        .shell {
            max-width: 1180px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 50px rgba(15,23,42,0.08);
            padding: 26px 24px 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            gap: 14px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        h2 {
            margin: 0;
            font-size: 28px;
            letter-spacing: -0.02em;
            font-family: 'Noto Serif KR', 'Pretendard', serif;
        }
        .sub {
            margin-top: 6px;
            color: var(--muted);
        }
        
        .layout {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 18px;
            margin-top: 22px;
            width: 100%;
        }
        .layout > * { min-width: 0; }
        .preview-card {
            position: relative;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            min-height: 0;
        }
        .template-frame {
            position: relative;
            width: 100%;
            min-height: 360px;
            background-size: cover;
            background-position: center;
            border-radius: 16px;
            border: 1px solid #d1d5db;
            overflow: hidden;
            box-shadow: 0 18px 36px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
            box-sizing: border-box;
        }
        .template-frame.postcard { aspect-ratio: 16 / 10; }
        .template-frame.letter { aspect-ratio: 2 / 3; }
        
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
        }
        
        /* ì—½ì„œ í…œí”Œë¦¿: ìœ„ì•„ë˜ 1ë‹¨ êµ¬ì¡° */
        .template-frame.postcard .overlay { 
            display: grid;
            grid-template-rows: 60% 40%;
            gap: 0;
            padding: 12% 6% 6%;
            justify-content: space-between;
        }
        
        .template-frame.postcard .left,
        .template-frame.postcard .right {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 100%;
            min-height: 0;
        }
        .template-frame.postcard .left {
            padding-top: 0;
        }
        
        .verse-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1 1 auto;
            max-height: none;
            justify-content: flex-start;
        }
        .verse-box .text {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .verse-box .ref {
            font-weight: 800;
            text-align: right;
            flex-shrink: 0;
            margin-top: 0.15em;
            align-self: flex-end;
            display: block;
            color: var(--ink);
            font-size: 13px;
        }
        .msg-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .msg-box .body {
            flex: 1;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        .sender-box {
            color: var(--ink);
            font-weight: 700;
            overflow: hidden;
            width: 100%;
            text-align: center;
            align-self: center;
        }
        
        .template-frame.postcard .verse-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
            min-height: 0;
        }
        
        .template-frame.postcard .msg-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
            min-height: 0;
        }
        
        .template-frame.postcard .sender-box {
            margin-top: auto;
            background: none;
            border: none;
            box-shadow: none;
            flex: 0 0 12.5%;
            padding-top: 2px;
            padding-bottom: 2px;
            line-height: 1.2;
            overflow: visible;
        }
        .template-frame.postcard .msg-box {
            flex: 0 0 87.5%;
        }
        .template-frame.postcard.no-message .overlay {
            grid-template-rows: 100%;
        }
        .template-frame.postcard.no-message .right {
            flex: 0 0 0;
            display: none;
        }
        .template-frame.postcard.no-message .left {
            justify-content: center;
            padding-top: 6%;
        }
        .template-frame.postcard.no-message .verse-box {
            max-width: 96%;
            margin: 0 auto;
        }
        .template-frame.postcard.no-message .sender-box {
            display: block;
            margin: 10px auto 0;
        }
        
        /* í¸ì§€ì§€ í…œí”Œë¦¿: ì„¸ë¡œ ë°°ì¹˜ */
        .template-frame.letter .overlay {
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 6%;
            padding: 10% 8%;
            height: 80%;
            margin: auto;
        }
        .template-frame.letter .left,
        .template-frame.letter .right {
            width: 80%;
            max-width: 760px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .template-frame.letter .left {
            flex: 0 0 40%;
            justify-content: center;
        }
        .template-frame.letter .right {
            flex: 0 0 40%;
            justify-content: flex-start;
            gap: 8px;
        }
        
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box,
        .template-frame.letter .sender-box {
            background: none;
            border: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box {
            width: 100%;
            max-width: 760px;
        }
        .template-frame.letter .msg-box {
            flex: 1 1 0;
            min-height: 0;
            overflow: hidden;
            height: 100%;
        }
        .template-frame.letter .msg-box .body {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .template-frame.letter .sender-box {
            width: 100%;
            max-width: 760px;
            border-radius: 0;
            align-self: center;
            text-align: center;
            margin-top: auto;
        }
        .template-frame.letter.no-message .right {
            flex: 0 0 0;
            display: none;
        }
        .template-frame.letter.no-message .left {
            flex: 1 1 auto;
            width: 100%;
            padding-top: 6%;
        }
        .template-frame.letter.no-message .verse-box {
            max-width: 96%;
            margin: 0 auto;
        }
        
        .side {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .font-section {
            flex: 1 1 auto;
        }
        .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .font-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .font-tab {
            border: 1px solid #d1d5db;
            border-radius: 999px;
            padding: 8px 12px;
            background: #fff;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: border 0.15s ease, box-shadow 0.15s ease;
        }
        .font-tab.active {
            border-color: #6366f1;
            box-shadow: 0 8px 16px rgba(79,70,229,0.2);
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
        }
        .font-option {
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fff;
            cursor: pointer;
            transition: border 0.15s ease, box-shadow 0.15s ease;
        }
        .font-option:hover {
            border-color: #94a3b8;
            box-shadow: 0 10px 20px rgba(0,0,0,0.06);
        }
        .font-option.active {
            border-color: #6366f1;
            box-shadow: 0 14px 28px rgba(79,70,229,0.16);
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
        }
        .font-label {
            font-weight: 800;
            color: #0f172a;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: auto;
        }
        button {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-weight: 800;
            cursor: pointer;
            font-size: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2b59ff 0%, #6c8bff 100%);
            color: #fff;
            border: none;
            box-shadow: 0 12px 24px rgba(59,130,246,0.25);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .tag {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4338ca;
            font-weight: 700;
            font-size: 12px;
            margin-left: 6px;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 540px) {
            body { padding: 14px 12px 18px; }
            .shell { padding: 16px 12px 20px; border-radius: 14px; }
            .header { flex-direction: column; gap: 10px; }
            
            .preview-card { width: 100%; }
            .template-frame { min-height: 320px; border-radius: 12px; width: 100%; max-width: 100%; margin: 0 auto; }
            .template-frame.postcard {
                background-size: contain;
                background-repeat: no-repeat;
            }
            .template-frame.postcard .overlay { 
                display: grid;
                grid-template-rows: 60% 40%;
                gap: 0; 
                padding: 10% 6% 8%; 
                justify-content: space-between;
            }
            .template-frame.postcard.no-message .overlay {
                padding: 15% 6% 3%;
            }
            .template-frame.postcard .left,
            .template-frame.postcard .right {
                padding-top: 0;
                gap: 8px;
                flex: 1 1 auto;
                width: 100%;
                min-height: 0;
            }
            .verse-box,
            .msg-box { font-size: 13px; word-break: break-word; }
            .verse-box .ref { font-size: 11px; }
            .side { padding: 12px; border-radius: 12px; }
            .font-tabs { flex-wrap: nowrap; }
            .font-tab { flex: 1 1 0; text-align: center; padding: 8px 6px; }
            .font-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; gap: 8px; }
            button { width: 100%; }
            /* í¸ì§€ì§€ ëª¨ë“œì—ì„œ ì¤‘ì•™ 80% ì˜ì—­ì— í…ìŠ¤íŠ¸ ë°°ì¹˜ */
            .template-frame.letter .overlay {
                padding: 8% 6%;
                gap: 6%;
                justify-content: space-between;
            }
            .template-frame.letter .verse-box {
                min-height: 40%;
                display: flex;
                align-items: center;
            }
            .template-frame.letter .msg-box,
            .template-frame.letter .sender-box {
                max-width: none;
            }
            .template-frame.letter .msg-box {
                min-height: 0;
            }
        }
        @media (min-width: 769px) {
            .verse-box .ref { margin-top: 0; }
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="header">
            <div>
                <h2>ì „ì†¡ ì „ ë¯¸ë¦¬ë³´ê¸°</h2>
                <div class="sub">ì„ íƒí•œ ë§ì”€ê³¼ í¸ì§€ë¥¼ ì›í•˜ëŠ” ê¸€ì”¨ì²´ë¡œ í™•ì¸í•˜ê³  ë³´ë‚´ì£¼ì„¸ìš”.</div>
            </div>
            
        </div>

        <div class="layout">
            <div class="preview-card">
                <div class="template-frame postcard" id="template-frame">
                    <div class="overlay">
                        <div class="left" id="left-column">
                            <div class="verse-box">
                                <div class="text" id="verse-text"></div>
                                <span class="ref" id="verse-ref"></span>
                            </div>
                        </div>
                        <div class="right" id="right-column">
                            <div class="msg-box">
                                <div class="body" id="message-text"></div>
                            </div>
                            <div class="sender-box" id="sender-box">
                                From. <span id="sender-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side">
                

                <div class="font-section">
                    <div style="font-weight:800; margin-bottom:8px; color:#0f172a;">ê¸€ì”¨ì²´ ì„ íƒ</div>
                    <div class="font-tabs" id="font-tabs"></div>
                    <div class="font-grid" id="font-grid"></div>
                </div>

                <div class="actions">
                    <button id="edit-btn">ìˆ˜ì •í•˜ê¸°</button>
                    <button class="btn-primary" id="send-btn">ì´ëŒ€ë¡œ ë³´ë‚¼ê²Œìš” ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const postboxId = "{{ postbox_id }}";
        const draftKey = `postcardDraft-${postboxId}`;
        const returnKey = `postboxReturnUrl-${postboxId}`;
        const templateAssets = {
            1: "{{ url_for('static', filename='images/postcards/postcard1.jpg') }}",
            2: "{{ url_for('static', filename='images/postcards/postcard2.jpg') }}",
            3: "{{ url_for('static', filename='images/postcards/postcard3.jpg') }}",
            4: "{{ url_for('static', filename='images/postcards/postcard4.jpg') }}",
            5: "{{ url_for('static', filename='images/postcards/postcard5.jpg') }}",
            6: "{{ url_for('static', filename='images/postcards/postcard6.jpg') }}",
            7: "{{ url_for('static', filename='images/postcards/postcard7.jpg') }}",
            8: "{{ url_for('static', filename='images/postcards/postcard8.jpg') }}",
            9: "{{ url_for('static', filename='images/postcards/postcard9.jpg') }}",
        };
        const FONT_OPTIONS = {
            'sans': {
                id: 'sans',
                label: 'ëª¨ë˜ ì‚°ì„¸ë¦¬í”„',
                desc: 'ê¹”ë”í•˜ê³  ë‹¨ì •í•œ ë¶„ìœ„ê¸°',
                fontFamily: "'Pretendard','Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif",
                sample: 'ëŠ˜ í‰ì•ˆê³¼ ì€í˜œê°€ í•¨ê»˜í•˜ê¸¸ ë°”ë¼ìš”.'
            },
            'serif': {
                id: 'serif',
                label: 'í´ë˜ì‹ ì„¸ë¦¬í”„',
                desc: 'ì „í†µì ì¸ í¸ì§€ ëŠë‚Œ',
                fontFamily: "'Noto Serif KR','Times New Roman','Apple SD Gothic Neo',serif",
                sample: 'ê¸°ë„ë¡œ í•¨ê»˜í•˜ë©° ì‘ì›í• ê²Œìš”.'
            },
            'hand': {
                id: 'hand',
                label: 'ë”°ëœ»í•œ ì†ê¸€ì”¨',
                desc: 'ì¹œê·¼í•œ í•„ê¸°ì²´ ëŠë‚Œ',
                fontFamily: "'Nanum Pen Script','Comic Sans MS','Apple SD Gothic Neo',cursive",
                sample: 'ë§ˆìŒ ê°€ë“ ì‚¬ë‘ì„ ë‹´ì•˜ì–´ìš”.'
            },
            'pyeojin': {
                id: 'pyeojin',
                label: 'í´ì§„ê³ ë”•',
                desc: 'ë‘¥ê¸€ë‘¥ê¸€í•œ ê³ ë”•ì²´',
                fontFamily: "'PyeojinGothic','Noto Sans KR','Apple SD Gothic Neo',sans-serif",
                sample: 'ë”°ëœ»í•˜ê²Œ ë§ˆìŒì„ ì „í•´ìš”.'
            },
            'kimmyoungjo': {
                id: 'kimmyoungjo',
                label: 'ê¹€ì •ì²  ëª…ì¡°',
                desc: 'ì–‡ê³  ìš°ì•„í•œ ëª…ì¡°',
                fontFamily: "'KimJeongcheolMyoungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ì€í˜œì™€ í‰ê°•ì´ ê°€ë“í•˜ê¸¸.'
            },
            'yesmyungjo': {
                id: 'yesmyungjo',
                label: 'ì˜ˆìŠ¤ ëª…ì¡°',
                desc: 'ì„ ëª…í•œ ì „í†µ ëª…ì¡°',
                fontFamily: "'YesMyungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ì§„ì‹¬ì„ ë‹´ì•„ ì‘ì›í•´ìš”.'
            },
            'schoolsafety': {
                id: 'schoolsafety',
                label: 'í•™êµì•ˆì „ë‚ ê°œ',
                desc: 'ë‘¥ê¸€ê³  ê·€ì—¬ìš´ ì†ê¸€ì”¨ ëŠë‚Œ',
                fontFamily: "'SchoolSafetyWing','Noto Sans KR','Apple SD Gothic Neo',cursive",
                sample: 'ë§ˆìŒ ê°€ë“ ì‘ì›ê³¼ ì‚¬ë‘ì„ ë‹´ì•˜ì–´ìš”.'
            }
        };

        const frameEl = document.getElementById('template-frame');
        const overlayEl = document.querySelector('.template-frame .overlay');
        const verseRefEl = document.getElementById('verse-ref');
        const verseTextEl = document.getElementById('verse-text');
        const messageTextEl = document.getElementById('message-text');
        const senderLabelEl = document.getElementById('sender-label');
<<<<<<< HEAD
=======
        const senderBoxEl = document.getElementById('sender-box');
        const rightColumnEl = document.getElementById('right-column');
        const leftColumnEl = document.getElementById('left-column');
>>>>>>> test02
        const fontTabsEl = document.getElementById('font-tabs');
        const fontGridEl = document.getElementById('font-grid');
        const sendBtn = document.getElementById('send-btn');
        const editBtn = document.getElementById('edit-btn');

        let draft = null;
        let selectedFont = 'serif';
        let activeFontCategory = 'sans';
        let templateImageSize = null;
        const FONT_CATEGORIES = [
            { id: 'sans', label: 'ê³ ë”•' },
            { id: 'serif', label: 'ëª…ì¡°' },
            { id: 'hand', label: 'ì†ê¸€ì”¨' }
        ];
        const SERIF_FONT_IDS = ['serif', 'kimmyoungjo', 'yesmyungjo'];

        function normalizeTemplate(tpl = {}) {
            const rawId = tpl.id;
            let id = parseInt(String(rawId || '').replace(/\\D+/g, ''), 10);
            if (!id) id = 1;
            const rawType = tpl.type;
            let typeInt = 0;
            if (typeof rawType === 'string') {
                const num = parseInt(rawType, 10);
                if (!Number.isNaN(num)) typeInt = num;
                else typeInt = rawType === 'í¸ì§€ì§€' ? 1 : 0;
            } else {
                typeInt = rawType ?? 0;
            }
            typeInt = typeInt === 1 ? 1 : 0;
            return {
                id,
                type: typeInt,
                typeLabel: typeInt === 1 ? 'í¸ì§€ì§€' : 'ì—½ì„œ',
                name: tpl.name || `í…œí”Œë¦¿ ${id}`
            };
        }

        function renderFontTabs() {
            fontTabsEl.innerHTML = '';
            FONT_CATEGORIES.forEach(category => {
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'font-tab' + (category.id === activeFontCategory ? ' active' : '');
                tab.textContent = category.label;
                tab.onclick = () => {
                    activeFontCategory = category.id;
                    renderFontTabs();
                    renderFontOptions();
                };
                fontTabsEl.appendChild(tab);
            });
        }

        function renderFontOptions() {
            fontGridEl.innerHTML = '';
            const filtered = Object.values(FONT_OPTIONS).filter(opt => {
                if (activeFontCategory === 'sans') return ['sans', 'pyeojin'].includes(opt.id);
                if (activeFontCategory === 'serif') return SERIF_FONT_IDS.includes(opt.id);
                if (activeFontCategory === 'hand') return ['hand', 'schoolsafety'].includes(opt.id);
                return true;
            });
            filtered.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'font-option';
                card.dataset.id = opt.id;
                card.innerHTML = `
                    <div class="font-label" style="font-family:${opt.fontFamily}">${opt.label}</div>
                    <div style="color:#6b7280; font-size:13px; margin-top:2px;">${opt.desc}</div>
                `;
                card.onclick = () => selectFont(opt.id);
                fontGridEl.appendChild(card);
            });
        }

        function selectFont(id) {
            const opt = FONT_OPTIONS[id] || FONT_OPTIONS.sans;
            selectedFont = opt.id;
            [messageTextEl, verseTextEl, verseRefEl, senderLabelEl].forEach(el => {
                el.style.fontFamily = opt.fontFamily;
            });
            document.querySelectorAll('.font-option').forEach(card => {
                card.classList.toggle('active', card.dataset.id === selectedFont);
            });
            
            // í°íŠ¸ ë³€ê²½ í›„ í…ìŠ¤íŠ¸ í¬ê¸° ì¬ì¡°ì •
            setTimeout(adjustAllText, 50);
            
            persistDraft();
        }


        function applyTemplate() {
            const tpl = normalizeTemplate(draft.template || {});
            const img = templateAssets[tpl.id];
            frameEl.style.backgroundImage = img ? `url(${img})` : '';
            frameEl.classList.remove('postcard', 'letter');
            frameEl.classList.add(tpl.type === 1 ? 'letter' : 'postcard');

            if (img) {
                const image = new Image();
                image.onload = () => {
                    templateImageSize = { width: image.naturalWidth, height: image.naturalHeight };
                    updateOverlayInset();
                };
                image.onerror = () => {
                    templateImageSize = null;
                    updateOverlayInset();
                };
                image.src = img;
            } else {
                templateImageSize = null;
                updateOverlayInset();
            }
        }

        function normalizeSingleLine(value) {
            return (value || '').replace(/\r?\n+/g, ' ');
        }

        function applyContent() {
            const verse = draft.verse || {};
            verseRefEl.textContent = verse.reference || 'ì„ íƒí•œ ë§ì”€';
            verseTextEl.textContent = (verse.text || '').replace(/\s+$/g, '');
            messageTextEl.textContent = normalizeSingleLine(draft.message ? draft.message : '');
            const senderName = (draft.sender_name || '').trim();
            const displayName = senderName || 'ìµëª…';
            senderLabelEl.textContent = displayName;
            const messageValue = normalizeSingleLine(draft.message ? draft.message : '');
            frameEl.classList.toggle('no-message', messageValue.length === 0);
            if (messageValue.length === 0 && senderBoxEl && leftColumnEl) {
                leftColumnEl.appendChild(senderBoxEl);
            } else if (messageValue.length > 0 && senderBoxEl && rightColumnEl && senderBoxEl.parentElement !== rightColumnEl) {
                rightColumnEl.appendChild(senderBoxEl);
            }

            setTimeout(updateOverlayInset, 60);
            setTimeout(adjustAllText, 100);
        }

        function persistDraft() {
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            try {
                const next = Object.assign({}, draft, {
                    font_family: opt.fontFamily,
                    font_style: opt.id
                });
                sessionStorage.setItem(draftKey, JSON.stringify(next));
            } catch (e) {
                console.warn('draft persist failed', e);
            }
        }

        function loadDraft() {
            try {
                const raw = sessionStorage.getItem(draftKey);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('draft parse failed', e);
                return null;
            }
        }

        async function sendPostcard() {
            if (!draft || !draft.verse) {
                alert('ì‘ì„± ì¤‘ì¸ í¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const tpl = normalizeTemplate(draft.template || {});
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            const message = normalizeSingleLine(draft.message || '');
            sendBtn.disabled = true;
            sendBtn.textContent = 'ì „ì†¡ ì¤‘...';
            try {
                const response = await fetch('/api/send-postcard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postbox_id: postboxId,
                        template_id: tpl.id,
                        template_type: tpl.type,
                        template_name: tpl.name,
                        sender_name: (draft.sender_name || '').trim(),
                        is_anonymous: !(draft.sender_name || '').trim(),
                        verse_reference: draft.verse.reference,
                        verse_text: draft.verse.text,
                        message,
                        font_family: opt.fontFamily,
                        font_style: opt.id
                    })
                });
                if (response.ok) {
                    sessionStorage.removeItem(draftKey);
                    const returnUrl = sessionStorage.getItem(returnKey);
                    sessionStorage.removeItem(returnKey);
                    alert('ì—½ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\\n2026ë…„ 1ì›” 1ì¼ì— ìƒëŒ€ë°©ì´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = returnUrl || '/';
                } else {
                    const err = await response.text();
                    alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n' + err);
                }
            } catch (e) {
                alert('ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ì´ëŒ€ë¡œ ë³´ë‚¼ê²Œìš” ğŸš€';
            }
        }
        // ========== í…ìŠ¤íŠ¸ ìë™ í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜ ==========
        function fitTextToContainer(element, minSize, maxSize, containerHeight = null, containerWidth = null) {
            if (!element || !element.textContent.trim()) return;
            
            let fontSize = maxSize;
            element.style.fontSize = fontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            // ì»¨í…Œì´ë„ˆ í¬ê¸°ê°€ ì§€ì •ëœ ê²½ìš° í•´ë‹¹ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ì•„ë‹ˆë©´ ìš”ì†Œ ìì²´ì˜ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ
            const refHeight = containerHeight !== null ? containerHeight : element.clientHeight;
            const refWidth = containerWidth !== null ? containerWidth : element.clientWidth;
            
            while ((element.scrollHeight > refHeight + 1 || 
                    element.scrollWidth > refWidth + 1) && 
                fontSize > minSize && iterations < maxIterations) {
                fontSize -= 0.3;
                element.style.fontSize = fontSize + 'px';
                iterations++;
            }
        }

        function fitTextToContainerFill(element, minSize, maxSize, containerHeight = null, containerWidth = null) {
            if (!element || !element.textContent.trim()) return;

            const refHeight = containerHeight !== null ? containerHeight : element.clientHeight;
            const refWidth = containerWidth !== null ? containerWidth : element.clientWidth;
            let fontSize = minSize;
            element.style.fontSize = fontSize + 'px';

            let iterations = 0;
            const maxIterations = 200;
            while (fontSize < maxSize && iterations < maxIterations) {
                element.style.fontSize = (fontSize + 0.3) + 'px';
                if (element.scrollHeight > refHeight + 1 || element.scrollWidth > refWidth + 1) {
                    element.style.fontSize = fontSize + 'px';
                    break;
                }
                fontSize += 0.3;
                iterations++;
            }
        }

        function fitVerseBox() {
            const verseBox = document.querySelector('.verse-box');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            if (!verseBox || !verseRef || !verseText) return;
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            
            let refMin, refMax, textMin, textMax;
            
            if (isMobile) {
                refMin = 6; refMax = 10;
                textMin = 6; textMax = 12;
            } else if (isTablet) {
                refMin = 7; refMax = 15;
                textMin = 7; textMax = 16;
            } else {
                refMin = 10; refMax = 20;
                textMin = 10; textMax = 24;
            }
            
            // ì œëª©(ref)ì„ ë¨¼ì € ë§ì¶¤
            fitTextToContainer(verseRef, refMin, refMax);
            
            // ì œëª©ì´ ì°¨ì§€í•œ ê³µê°„ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ì— ë³¸ë¬¸ ë§ì¶¤
            const verseBoxHeight = verseBox.clientHeight;
            const refHeight = verseRef.offsetHeight;
            const refMargin = parseInt(getComputedStyle(verseRef).marginTop || 0);
            const availableHeight = verseBoxHeight - refHeight - refMargin;
            
            let textFontSize = textMax;
            verseText.style.fontSize = textFontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            while ((verseText.scrollHeight > availableHeight + 1 || 
                    verseText.scrollWidth > verseText.clientWidth + 1) && 
                textFontSize > textMin && iterations < maxIterations) {
                textFontSize -= 0.3;
                verseText.style.fontSize = textFontSize + 'px';
                iterations++;
            }
        }

        function adjustAllText() {
            const msgBoxContainer = document.querySelector('.msg-box');
            const msgBox = document.getElementById('message-text');
            const senderBoxContainer = document.querySelector('.sender-box');
            const senderBox = document.getElementById('sender-label');
            const rightColumn = document.querySelector('.template-frame.postcard .right');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            let msgMin, msgMax, senderMin, senderMax;
            if (isMobile) {
                msgMin = 10; msgMax = 18;
                senderMin = 10; senderMax = 12;
            } else if (isTablet) {
                msgMin = 12; msgMax = 20;
                senderMin = 10; senderMax = 12;
            } else {
                msgMin = 12; msgMax = 28;
                senderMin = 20; senderMax = 20;
            }
            
            // ì„±ê²½ êµ¬ì ˆ ì˜ì—­ (ì œëª© + ë³¸ë¬¸)
            fitVerseBox();
            if (verseRef && verseText) {
                // ref í¬ê¸°ë¥¼ ë³¸ë¬¸ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤
                verseRef.style.fontSize = getComputedStyle(verseText).fontSize;
            }
            
            // ë©”ì‹œì§€ ì˜ì—­
            if (msgBox && msgBoxContainer) {
                // ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì ˆ
                fitTextToContainer(msgBox, msgMin, msgMax, msgBoxContainer.clientHeight, msgBoxContainer.clientWidth);

                // ì—¬ì „íˆ ë„˜ì¹˜ë©´ ë” ì¶•ì†Œ
                if (msgBox.scrollHeight > msgBoxContainer.clientHeight + 1) {
                    const hardMin = msgMin;
                    const currentSize = parseFloat(getComputedStyle(msgBox).fontSize) || msgMax;
                    fitTextToContainer(msgBox, hardMin, currentSize, msgBoxContainer.clientHeight, msgBoxContainer.clientWidth);
                }
            }
            if (senderBox && msgBox) {
                // ë°œì‹ ì í¬ê¸°ë¥¼ ë³¸ë¬¸ë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ ë§ì¶¤
                const baseSize = getComputedStyle(msgBox).fontSize;
                const baseSizeNum = parseFloat(baseSize) || 0;
                const senderSize = baseSizeNum ? Math.max(baseSizeNum, senderMin) + 'px' : baseSize;
                senderBox.style.fontSize = senderSize;
                const wrapper = senderBox.parentElement;
                if (wrapper) wrapper.style.fontSize = senderSize;
            }
            
            // ë°œì‹ ì ì˜ì—­
            if (senderBox && senderBoxContainer) {
                // ì»¨í…Œì´ë„ˆ í¬ê¸°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì ˆ
                fitTextToContainer(senderBox, senderMin, senderMax, senderBoxContainer.clientHeight, senderBoxContainer.clientWidth);
                const senderFontSize = getComputedStyle(senderBox).fontSize;
                senderBoxContainer.style.fontSize = senderFontSize;
            }

            // rightColumn overflow ë³´ì •ì€ gapì„ ì œê±°í–ˆìœ¼ë¯€ë¡œ ìƒëµ
        }

        function updateOverlayInset() {
            if (!frameEl || !overlayEl || !frameEl.classList.contains('postcard')) {
                return;
            }
            const style = getComputedStyle(frameEl);
            const bgSize = style.backgroundSize;
            const frameW = frameEl.clientWidth;
            const frameH = frameEl.clientHeight;
            let bgW = 0;
            let bgH = 0;

            if (templateImageSize && templateImageSize.width && templateImageSize.height) {
                const scale = Math.min(frameW / templateImageSize.width, frameH / templateImageSize.height);
                bgW = templateImageSize.width * scale;
                bgH = templateImageSize.height * scale;
            } else if (bgSize && bgSize !== 'cover' && bgSize !== 'auto' && bgSize !== 'auto auto') {
                const parts = bgSize.split(' ');
                if (parts.length >= 2 && parts[0].includes('px') && parts[1].includes('px')) {
                    bgW = parseFloat(parts[0]) || 0;
                    bgH = parseFloat(parts[1]) || 0;
                }
            }

            if (!bgW || !bgH) {
                overlayEl.style.inset = '0px';
                return;
            }

            const insetX = Math.max((frameW - bgW) / 2, 0);
            const insetY = Math.max((frameH - bgH) / 2, 0);
            overlayEl.style.inset = `${insetY}px ${insetX}px`;
        }

        // í˜ì´ì§€ ë¡œë“œ ë° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì‹¤í–‰
        window.addEventListener('load', () => {
            updateOverlayInset();
            setTimeout(adjustAllText, 100);
        });
        window.addEventListener('resize', () => {
            updateOverlayInset();
            adjustAllText();
        });

        function init() {
            draft = loadDraft();
            if (!draft || !draft.verse) {
                alert('ì‘ì„± ì¤‘ì¸ í¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‘ì„± í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = `/send/${postboxId}/write`;
                return;
            }
            renderFontTabs();
            renderFontOptions();
            applyTemplate();
            applyContent();

            let initialFont = draft.font_style;
            if (!initialFont && draft.font_family) {
                const hit = Object.values(FONT_OPTIONS).find(opt => opt.fontFamily === draft.font_family);
                if (hit) initialFont = hit.id;
            }
            selectedFont = FONT_OPTIONS[initialFont] ? initialFont : 'serif';
            selectFont(selectedFont);
        }

        sendBtn.addEventListener('click', sendPostcard);
        editBtn.addEventListener('click', () => window.location.href = `/send/${postboxId}/write`);
        init();

    </script>
</body>
</html>
