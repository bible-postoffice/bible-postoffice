<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎØ∏Î¶¨Î≥¥Í∏∞ & Í∏ÄÏî®Ï≤¥</title>
    <style>
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Thin.woff2') format('woff2');
            font-weight: 100;
            font-display: swap;
}

        @font-face {
            font-family: 'PyeojinGothic';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2504-1@1.0/PyeojinGothic-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: 'KimJeongcheolMyoungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2302_01@1.0/KimjungchulMyungjo-Light.woff2') format('woff2');
            font-weight: 300;
            font-display: swap;
        }
        @font-face {
            font-family: 'YesMyungjo';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_13@1.0/YESMyoungjo-Regular.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SchoolSafetyWing';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/HakgyoansimNalgaeR.woff2') format('woff2');
            font-weight: normal;
            font-display: swap;
        }
        :root {
            --ink: #0f172a;
            --muted: #6b7280;
            --accent: #6366f1;
            --panel: #ffffff;
            --bg: #f5f7fb;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Pretendard', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--ink);
            padding: 28px 16px 34px;
        }
        .shell {
            max-width: 1180px;
            margin: 0 auto;
            background: var(--panel);
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 50px rgba(15,23,42,0.08);
            padding: 26px 24px 30px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            gap: 14px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        h2 {
            margin: 0;
            font-size: 28px;
            letter-spacing: -0.02em;
            font-family: 'Noto Serif KR', 'Pretendard', serif;
        }
        .sub {
            margin-top: 6px;
            color: var(--muted);
        }
        .steps {
            display: flex;
            gap: 8px;
        }
        .step {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f8fafc;
            color: #4b5563;
            font-weight: 700;
            min-width: 120px;
        }
        .step.active {
            background: linear-gradient(135deg, #2b59ff 0%, #6c8bff 100%);
            border: none;
            color: #fff;
            box-shadow: 0 12px 24px rgba(59,130,246,0.25);
        }
        .step.completed {
            background: #e0f2fe;
            color: #2563eb;
            border-color: #bfdbfe;
        }
        .layout {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 18px;
            margin-top: 22px;
            width: 100%;
        }
        .layout > * { min-width: 0; }
        .preview-card {
            position: relative;
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            min-height: 0;
        }
        .template-frame {
            position: relative;
            width: 100%;
            min-height: 360px;
            background-size: cover;
            background-position: center;
            border-radius: 16px;
            border: 1px solid #d1d5db;
            overflow: hidden;
            box-shadow: 0 18px 36px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s ease;
            box-sizing: border-box;
        }
        .template-frame.postcard { aspect-ratio: 16 / 10; }
        .template-frame.letter { aspect-ratio: 2 / 3; }
        
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
        }
        
        /* ÏóΩÏÑú ÌÖúÌîåÎ¶ø: Ï¢åÏö∞ 2Îã® Íµ¨Ï°∞ */
        .template-frame.postcard .overlay { 
            flex-direction: row; 
            gap: 1.5%;
            padding: 6% 4%;
        }
        
        .template-frame.postcard .left,
        .template-frame.postcard .right {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 10%;
        }
        .template-frame.postcard .right {
            padding-top: 8%;
        }
        
        .verse-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex: 1 1 auto;
            max-height: none;
            justify-content: flex-start;
        }
        .verse-box .text {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .verse-box .ref {
            font-weight: 800;
            text-align: right;
            flex-shrink: 0;
            margin-top: 0.3em;
            align-self: flex-end;
            display: block;
            color: var(--ink);
            font-size: 13px;
        }
        .msg-box {
            color: var(--ink);
            line-height: 1.5;
            font-weight: 600;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .msg-box .body {
            flex: 1;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: auto;
        }
        .sender-box {
            color: var(--ink);
            font-weight: 700;
            overflow: hidden;
            width: 100%;
            text-align: right;
            align-self: flex-end;
        }
        
        .template-frame.postcard .verse-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
        }
        
        .template-frame.postcard .msg-box {
            flex: 1;
            background: none;
            border: none;
            box-shadow: none;
        }
        
        .template-frame.postcard .sender-box {
            margin-top: auto;
            background: none;
            border: none;
            box-shadow: none;
            text-align: right;
        }
        
        /* Ìé∏ÏßÄÏßÄ ÌÖúÌîåÎ¶ø: ÏÑ∏Î°ú Î∞∞Ïπò */
        .template-frame.letter .overlay {
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 6%;
            padding: 10% 8%;
            height: 80%;
            margin: auto;
        }
        .template-frame.letter .left,
        .template-frame.letter .right {
            width: 80%;
            max-width: 760px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .template-frame.letter .left {
            flex: 0 0 40%;
            justify-content: center;
        }
        .template-frame.letter .right {
            flex: 0 0 40%;
            justify-content: flex-start;
            gap: 8px;
        }
        
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box,
        .template-frame.letter .sender-box {
            background: none;
            border: none;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        .template-frame.letter .verse-box,
        .template-frame.letter .msg-box {
            width: 100%;
            max-width: 760px;
        }
        .template-frame.letter .msg-box {
            flex: 1 1 0;
            min-height: 0;
            overflow: auto;
            height: 100%;
        }
        .template-frame.letter .msg-box .body {
            height: 100%;
            display: flex;
            align-items: center;
        }
        .template-frame.letter .sender-box {
            width: 100%;
            max-width: 760px;
            border-radius: 0;
            align-self: center;
            text-align: right;
            margin-top: 0;
        }
        
        .side {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .pill {
            align-self: flex-start;
            background: rgba(16,185,129,0.12);
            color: #0f9c68;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 800;
            font-size: 12px;
        }
        .summary {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 14px;
            background: #fff;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 6px 0;
            color: #374151;
            font-weight: 600;
        }
        .font-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        .font-option {
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 10px 12px;
            background: #fff;
            cursor: pointer;
            transition: border 0.15s ease, box-shadow 0.15s ease;
        }
        .font-option:hover {
            border-color: #94a3b8;
            box-shadow: 0 10px 20px rgba(0,0,0,0.06);
        }
        .font-option.active {
            border-color: #6366f1;
            box-shadow: 0 14px 28px rgba(79,70,229,0.16);
            background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%);
        }
        .font-label {
            font-weight: 800;
            color: #0f172a;
        }
        .font-preview {
            margin-top: 8px;
            color: #374151;
            line-height: 1.4;
        }
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 4px;
        }
        button {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            background: #fff;
            font-weight: 800;
            cursor: pointer;
            font-size: 15px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2b59ff 0%, #6c8bff 100%);
            color: #fff;
            border: none;
            box-shadow: 0 12px 24px rgba(59,130,246,0.25);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .tag {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4338ca;
            font-weight: 700;
            font-size: 12px;
            margin-left: 6px;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 540px) {
            body { padding: 14px 12px 18px; }
            .shell { padding: 16px 12px 20px; border-radius: 14px; }
            .header { flex-direction: column; gap: 10px; }
            .steps { width: 100%; gap: 6px; }
            .step { flex: 1; text-align: center; padding: 10px 8px; min-width: auto; }
            .template-frame { min-height: 240px; border-radius: 12px; }
            .template-frame.postcard .overlay { 
                flex-direction: row; 
                gap: 1.5%; 
                padding: 6% 4%; 
            }
            .template-frame.postcard .left,
            .template-frame.postcard .right {
                padding-top: 12%;
                gap: 6px;
                flex: 1 1 0;
            }
            .verse-box,
            .msg-box { font-size: 13px; word-break: break-word; }
            .verse-box .ref { font-size: 11px; }
            .side { padding: 12px; border-radius: 12px; }
            .font-grid { grid-template-columns: 1fr; }
            .actions { grid-template-columns: 1fr; gap: 8px; }
            button { width: 100%; }
            /* Ìé∏ÏßÄÏßÄ Î™®ÎìúÏóêÏÑú Ï§ëÏïô 80% ÏòÅÏó≠Ïóê ÌÖçÏä§Ìä∏ Î∞∞Ïπò */
            .template-frame.letter .overlay {
                padding: 8% 6%;
                gap: 6%;
                justify-content: space-between;
            }
            .template-frame.letter .verse-box {
                min-height: 40%;
                display: flex;
                align-items: center;
            }
            .template-frame.letter .msg-box,
            .template-frame.letter .sender-box {
                max-width: none;
            }
            .template-frame.letter .msg-box {
                min-height: 0;
            }
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="header">
            <div>
                <h2>Ï†ÑÏÜ° Ï†Ñ ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
                <div class="sub">ÏÑ†ÌÉùÌïú ÎßêÏîÄÍ≥º Ìé∏ÏßÄÎ•º ÏõêÌïòÎäî Í∏ÄÏî®Ï≤¥Î°ú ÌôïÏù∏ÌïòÍ≥† Î≥¥ÎÇ¥Ï£ºÏÑ∏Ïöî.</div>
            </div>
            <div class="steps">
                <div class="step completed">1. ÌÖúÌîåÎ¶ø</div>
                <div class="step completed">2. ÏûëÏÑ±</div>
                <div class="step active">3. ÎØ∏Î¶¨Î≥¥Í∏∞</div>
            </div>
        </div>

        <div class="layout">
            <div class="preview-card">
                <div class="template-frame postcard" id="template-frame">
                    <div class="overlay">
                        <div class="left">
                            <div class="verse-box">
                                <div class="text" id="verse-text"></div>
                                <span class="ref" id="verse-ref"></span>
                            </div>
                        </div>
                        <div class="right">
                            <div class="msg-box">
                                <div class="body" id="message-text"></div>
                            </div>
                            <div class="sender-box">
                                From. <span id="sender-label"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="side">
                <span class="pill">Ï†ÑÏÜ° Ï†Ñ ÌôïÏù∏</span>
                <div class="summary">
                    <div class="summary-row">
                        <span>ÏÑ†ÌÉùÌïú ÌÖúÌîåÎ¶ø</span>
                        <span id="summary-template"></span>
                    </div>
                    <div class="summary-row">
                        <span>ÎßêÏîÄ</span>
                        <span id="summary-verse"></span>
                    </div>
                    <div class="summary-row">
                        <span>ÏùµÎ™Ö Ïó¨Î∂Ä</span>
                        <span id="summary-anon"></span>
                    </div>
                    
                </div>

                <div>
                    <div style="font-weight:800; margin-bottom:8px; color:#0f172a;">Í∏ÄÏî®Ï≤¥ ÏÑ†ÌÉù</div>
                    <div class="font-grid" id="font-grid"></div>
                </div>

                <div class="actions">
                    <button class="btn-primary" id="send-btn">Ïù¥ÎåÄÎ°ú Î≥¥ÎÇºÍ≤åÏöî üöÄ</button>
                    <button id="edit-btn">ÏàòÏ†ïÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const postboxId = "{{ postbox_id }}";
        const draftKey = `postcardDraft-${postboxId}`;
        const templateAssets = {
            1: "{{ url_for('static', filename='images/postcards/POSTCARD1.png') }}",
            2: "{{ url_for('static', filename='images/postcards/POSTCARD2.png') }}",
            3: "{{ url_for('static', filename='images/postcards/POSTCARD3.png') }}",
            4: "{{ url_for('static', filename='images/postcards/POSTCARD4.png') }}",
            5: "{{ url_for('static', filename='images/letters/letter1.png') }}",
            6: "{{ url_for('static', filename='images/letters/letter2.png') }}",
            7: "{{ url_for('static', filename='images/letters/letter3.png') }}",
            8: "{{ url_for('static', filename='images/letters/letter4.jpg') }}",
        };
        const FONT_OPTIONS = {
            'sans': {
                id: 'sans',
                label: 'Î™®Îçò ÏÇ∞ÏÑ∏Î¶¨ÌîÑ',
                desc: 'ÍπîÎÅîÌïòÍ≥† Îã®Ï†ïÌïú Î∂ÑÏúÑÍ∏∞',
                fontFamily: "'Pretendard','Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif",
                sample: 'Îäò ÌèâÏïàÍ≥º ÏùÄÌòúÍ∞Ä Ìï®ÍªòÌïòÍ∏∏ Î∞îÎùºÏöî.'
            },
            'serif': {
                id: 'serif',
                label: 'ÌÅ¥ÎûòÏãù ÏÑ∏Î¶¨ÌîÑ',
                desc: 'Ï†ÑÌÜµÏ†ÅÏù∏ Ìé∏ÏßÄ ÎäêÎÇå',
                fontFamily: "'Noto Serif KR','Times New Roman','Apple SD Gothic Neo',serif",
                sample: 'Í∏∞ÎèÑÎ°ú Ìï®ÍªòÌïòÎ©∞ ÏùëÏõêÌï†Í≤åÏöî.'
            },
            'hand': {
                id: 'hand',
                label: 'Îî∞ÎúªÌïú ÏÜêÍ∏ÄÏî®',
                desc: 'ÏπúÍ∑ºÌïú ÌïÑÍ∏∞Ï≤¥ ÎäêÎÇå',
                fontFamily: "'Nanum Pen Script','Comic Sans MS','Apple SD Gothic Neo',cursive",
                sample: 'ÎßàÏùå Í∞ÄÎìù ÏÇ¨ÎûëÏùÑ Îã¥ÏïòÏñ¥Ïöî.'
            },
            'pyeojin': {
                id: 'pyeojin',
                label: 'Ìé¥ÏßÑÍ≥†Îîï',
                desc: 'Îë•Í∏ÄÎë•Í∏ÄÌïú Í≥†ÎîïÏ≤¥',
                fontFamily: "'PyeojinGothic','Noto Sans KR','Apple SD Gothic Neo',sans-serif",
                sample: 'Îî∞ÎúªÌïòÍ≤å ÎßàÏùåÏùÑ Ï†ÑÌï¥Ïöî.'
            },
            'kimmyoungjo': {
                id: 'kimmyoungjo',
                label: 'ÍπÄÏ†ïÏ≤† Î™ÖÏ°∞',
                desc: 'ÏñáÍ≥† Ïö∞ÏïÑÌïú Î™ÖÏ°∞',
                fontFamily: "'KimJeongcheolMyoungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ÏùÄÌòúÏôÄ ÌèâÍ∞ïÏù¥ Í∞ÄÎìùÌïòÍ∏∏.'
            },
            'yesmyungjo': {
                id: 'yesmyungjo',
                label: 'ÏòàÏä§ Î™ÖÏ°∞',
                desc: 'ÏÑ†Î™ÖÌïú Ï†ÑÌÜµ Î™ÖÏ°∞',
                fontFamily: "'YesMyungjo','Noto Serif KR','Times New Roman',serif",
                sample: 'ÏßÑÏã¨ÏùÑ Îã¥ÏïÑ ÏùëÏõêÌï¥Ïöî.'
            },
            'schoolsafety': {
                id: 'schoolsafety',
                label: 'ÌïôÍµêÏïàÏ†ÑÎÇ†Í∞ú',
                desc: 'Îë•Í∏ÄÍ≥† Í∑ÄÏó¨Ïö¥ ÏÜêÍ∏ÄÏî® ÎäêÎÇå',
                fontFamily: "'SchoolSafetyWing','Noto Sans KR','Apple SD Gothic Neo',cursive",
                sample: 'ÎßàÏùå Í∞ÄÎìù ÏùëÏõêÍ≥º ÏÇ¨ÎûëÏùÑ Îã¥ÏïòÏñ¥Ïöî.'
            }
        };

        const frameEl = document.getElementById('template-frame');
        const verseRefEl = document.getElementById('verse-ref');
        const verseTextEl = document.getElementById('verse-text');
        const messageTextEl = document.getElementById('message-text');
        const senderLabelEl = document.getElementById('sender-label');
        const summaryTemplateEl = document.getElementById('summary-template');
        const summaryVerseEl = document.getElementById('summary-verse');
        const summaryAnonEl = document.getElementById('summary-anon');
        const summaryMessageEl = document.getElementById('summary-message');
        const fontGridEl = document.getElementById('font-grid');
        const sendBtn = document.getElementById('send-btn');
        const editBtn = document.getElementById('edit-btn');

        let draft = null;
        let selectedFont = 'serif';

        function normalizeTemplate(tpl = {}) {
            const rawId = tpl.id;
            let id = parseInt(String(rawId || '').replace(/\\D+/g, ''), 10);
            if (!id) id = 1;
            const rawType = tpl.type;
            let typeInt = 0;
            if (typeof rawType === 'string') {
                const num = parseInt(rawType, 10);
                if (!Number.isNaN(num)) typeInt = num;
                else typeInt = rawType === 'Ìé∏ÏßÄÏßÄ' ? 1 : 0;
            } else {
                typeInt = rawType ?? 0;
            }
            typeInt = typeInt === 1 ? 1 : 0;
            return {
                id,
                type: typeInt,
                typeLabel: typeInt === 1 ? 'Ìé∏ÏßÄÏßÄ' : 'ÏóΩÏÑú',
                name: tpl.name || `ÌÖúÌîåÎ¶ø ${id}`
            };
        }

        function renderFontOptions() {
            fontGridEl.innerHTML = '';
            Object.values(FONT_OPTIONS).forEach(opt => {
                const card = document.createElement('div');
                card.className = 'font-option';
                card.dataset.id = opt.id;
                card.innerHTML = `
                    <div class="font-label">${opt.label}</div>
                    <div style="color:#6b7280; font-size:13px; margin-top:2px;">${opt.desc}</div>
                    <div class="font-preview" style="font-family:${opt.fontFamily}">${opt.sample}</div>
                `;
                card.onclick = () => selectFont(opt.id);
                fontGridEl.appendChild(card);
            });
        }

        function selectFont(id) {
            const opt = FONT_OPTIONS[id] || FONT_OPTIONS.sans;
            selectedFont = opt.id;
            [messageTextEl, verseTextEl, verseRefEl, senderLabelEl].forEach(el => {
                el.style.fontFamily = opt.fontFamily;
            });
            document.querySelectorAll('.font-option').forEach(card => {
                card.classList.toggle('active', card.dataset.id === selectedFont);
            });
            
            // Ìè∞Ìä∏ Î≥ÄÍ≤Ω ÌõÑ ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ Ïû¨Ï°∞Ï†ï
            setTimeout(adjustAllText, 50);
            
            persistDraft();
        }


        function applyTemplate() {
            const tpl = normalizeTemplate(draft.template || {});
            const img = templateAssets[tpl.id];
            frameEl.style.backgroundImage = img ? `url(${img})` : '';
            frameEl.classList.remove('postcard', 'letter');
            frameEl.classList.add(tpl.type === 1 ? 'letter' : 'postcard');

            summaryTemplateEl.textContent = `${tpl.typeLabel} ${tpl.name}`;
        }

        function applyContent() {
            const verse = draft.verse || {};
            verseRefEl.textContent = verse.reference || 'ÏÑ†ÌÉùÌïú ÎßêÏîÄ';
            verseTextEl.textContent = verse.text || '';
            messageTextEl.textContent = draft.message ? draft.message : 'Ìé∏ÏßÄÎ•º ÎÇ®Í∏∞ÏßÄ ÏïäÏïòÏñ¥Ïöî.';
            senderLabelEl.textContent = draft.is_anonymous ? 'ÏùµÎ™Ö' : 'Î≥¥ÎÇ¥Îäî ÏπúÍµ¨';

            summaryVerseEl.textContent = verse.reference || '-';
            summaryAnonEl.textContent = draft.is_anonymous ? 'ÏùµÎ™Ö' : 'Ïù¥Î¶Ñ Í≥µÍ∞ú';
            summaryMessageEl.textContent = draft.message ? `${draft.message.length}Ïûê` : 'ÏûëÏÑ±ÌïòÏßÄ ÏïäÏùå';
            setTimeout(adjustAllText, 100);
        }

        function persistDraft() {
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            try {
                const next = Object.assign({}, draft, {
                    font_family: opt.fontFamily,
                    font_style: opt.id
                });
                sessionStorage.setItem(draftKey, JSON.stringify(next));
            } catch (e) {
                console.warn('draft persist failed', e);
            }
        }

        function loadDraft() {
            try {
                const raw = sessionStorage.getItem(draftKey);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('draft parse failed', e);
                return null;
            }
        }

        async function sendPostcard() {
            if (!draft || !draft.verse) {
                alert('ÏûëÏÑ± Ï§ëÏù∏ Ìé∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            const tpl = normalizeTemplate(draft.template || {});
            const opt = FONT_OPTIONS[selectedFont] || FONT_OPTIONS.sans;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Ï†ÑÏÜ° Ï§ë...';
            try {
                const response = await fetch('/api/send-postcard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postbox_id: postboxId,
                        template_id: tpl.id,
                        template_type: tpl.type,
                        template_name: tpl.name,
                        is_anonymous: !!draft.is_anonymous,
                        verse_reference: draft.verse.reference,
                        verse_text: draft.verse.text,
                        message: draft.message || '',
                        font_family: opt.fontFamily,
                        font_style: opt.id
                    })
                });
                if (response.ok) {
                    sessionStorage.removeItem(draftKey);
                    alert('ÏóΩÏÑúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§! üéâ\\n2026ÎÖÑ 1Ïõî 1ÏùºÏóê ÏÉÅÎåÄÎ∞©Ïù¥ ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                    window.location.href = '/';
                } else {
                    const err = await response.text();
                    alert('Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\\n' + err);
                }
            } catch (e) {
                alert('Ï†ÑÏÜ° Ïã§Ìå®: ' + e.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Ïù¥ÎåÄÎ°ú Î≥¥ÎÇºÍ≤åÏöî üöÄ';
            }
        }
        // ========== ÌÖçÏä§Ìä∏ ÏûêÎèô ÌÅ¨Í∏∞ Ï°∞Ï†à Ìï®Ïàò ==========
        function fitTextToContainer(element, minSize, maxSize, containerHeight = null, containerWidth = null) {
            if (!element || !element.textContent.trim()) return;
            
            let fontSize = maxSize;
            element.style.fontSize = fontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Í∞Ä ÏßÄÏ†ïÎêú Í≤ΩÏö∞ Ìï¥Îãπ ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú, ÏïÑÎãàÎ©¥ ÏöîÏÜå ÏûêÏ≤¥Ïùò ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú
            const refHeight = containerHeight !== null ? containerHeight : element.clientHeight;
            const refWidth = containerWidth !== null ? containerWidth : element.clientWidth;
            
            while ((element.scrollHeight > refHeight + 1 || 
                    element.scrollWidth > refWidth + 1) && 
                fontSize > minSize && iterations < maxIterations) {
                fontSize -= 0.3;
                element.style.fontSize = fontSize + 'px';
                iterations++;
            }
        }

        function fitVerseBox() {
            const verseBox = document.querySelector('.verse-box');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            if (!verseBox || !verseRef || !verseText) return;
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            
            let refMin, refMax, textMin, textMax;
            
            if (isMobile) {
                refMin = 8; refMax = 10;
                textMin = 5; textMax = 12;
            } else if (isTablet) {
                refMin = 8; refMax = 15;
                textMin = 7; textMax = 16;
            } else {
                refMin = 12; refMax = 20;
                textMin = 10; textMax = 24;
            }
            
            // Ï†úÎ™©(ref)ÏùÑ Î®ºÏ†Ä ÎßûÏ∂§
            fitTextToContainer(verseRef, refMin, refMax);
            
            // Ï†úÎ™©Ïù¥ Ï∞®ÏßÄÌïú Í≥µÍ∞ÑÏùÑ Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄÏóê Î≥∏Î¨∏ ÎßûÏ∂§
            const verseBoxHeight = verseBox.clientHeight;
            const refHeight = verseRef.offsetHeight;
            const refMargin = parseInt(getComputedStyle(verseRef).marginTop || 0);
            const availableHeight = verseBoxHeight - refHeight - refMargin;
            
            let textFontSize = textMax;
            verseText.style.fontSize = textFontSize + 'px';
            
            let iterations = 0;
            const maxIterations = 200;
            
            while ((verseText.scrollHeight > availableHeight + 1 || 
                    verseText.scrollWidth > verseText.clientWidth + 1) && 
                textFontSize > textMin && iterations < maxIterations) {
                textFontSize -= 0.3;
                verseText.style.fontSize = textFontSize + 'px';
                iterations++;
            }
        }

        function adjustAllText() {
            const msgBoxContainer = document.querySelector('.msg-box');
            const msgBox = document.getElementById('message-text');
            const senderBoxContainer = document.querySelector('.sender-box');
            const senderBox = document.getElementById('sender-label');
            const verseRef = document.getElementById('verse-ref');
            const verseText = document.getElementById('verse-text');
            
            const isMobile = window.innerWidth <= 480;
            const isTablet = window.innerWidth <= 768 && window.innerWidth > 480;
            
            // ÏÑ±Í≤Ω Íµ¨Ï†à ÏòÅÏó≠ (Ï†úÎ™© + Î≥∏Î¨∏)
            fitVerseBox();
            if (verseRef && verseText) {
                // ref ÌÅ¨Í∏∞Î•º Î≥∏Î¨∏Í≥º ÎèôÏùºÌïòÍ≤å ÎßûÏ∂§
                verseRef.style.fontSize = getComputedStyle(verseText).fontSize;
            }
            
            // Î©îÏãúÏßÄ ÏòÅÏó≠
            if (msgBox && msgBoxContainer) {
                let msgMin, msgMax;
                if (isMobile) {
                    msgMin = 4; msgMax = 14;
                } else if (isTablet) {
                    msgMin = 6; msgMax = 18;
                } else {
                    msgMin = 10; msgMax = 24;
                }
                
                // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú Ï°∞Ï†à
                fitTextToContainer(msgBox, msgMin, msgMax, msgBoxContainer.clientHeight, msgBoxContainer.clientWidth);
            }
            if (senderBox && msgBox) {
                // Î∞úÏã†Ïûê ÌÅ¨Í∏∞Î•º Î≥∏Î¨∏Î≥¥Îã§ Ï°∞Í∏à ÏûëÍ≤å ÎßûÏ∂§
                const baseSize = getComputedStyle(msgBox).fontSize;
                const baseSizeNum = parseFloat(baseSize) || 0;
                const senderSize = baseSizeNum ? Math.max(baseSizeNum - 3, 6) + 'px' : baseSize;
                senderBox.style.fontSize = senderSize;
                const wrapper = senderBox.parentElement;
                if (wrapper) wrapper.style.fontSize = senderSize;
            }
            
            // Î∞úÏã†Ïûê ÏòÅÏó≠
            if (senderBox && senderBoxContainer) {
                let senderMin, senderMax;
                if (isMobile) {
                    senderMin = 5; senderMax = 13;
                } else if (isTablet) {
                    senderMin = 7; senderMax = 17;
                } else {
                    senderMin = 11; senderMax = 25;
                }
                
                // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Î•º Í∏∞Ï§ÄÏúºÎ°ú Ï°∞Ï†à
                fitTextToContainer(senderBox, senderMin, senderMax, senderBoxContainer.clientHeight, senderBoxContainer.clientWidth);
            }
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Î∞è Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Ïã§Ìñâ
        window.addEventListener('load', () => {
            setTimeout(adjustAllText, 100);
        });
        window.addEventListener('resize', adjustAllText);

        function init() {
            draft = loadDraft();
            if (!draft || !draft.verse) {
                alert('ÏûëÏÑ± Ï§ëÏù∏ Ìé∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Îã§Ïãú ÏûëÏÑ± ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
                window.location.href = `/send/${postboxId}/write`;
                return;
            }
            renderFontOptions();
            applyTemplate();
            applyContent();

            let initialFont = draft.font_style;
            if (!initialFont && draft.font_family) {
                const hit = Object.values(FONT_OPTIONS).find(opt => opt.fontFamily === draft.font_family);
                if (hit) initialFont = hit.id;
            }
            selectedFont = FONT_OPTIONS[initialFont] ? initialFont : 'serif';
            selectFont(selectedFont);
        }

        sendBtn.addEventListener('click', sendPostcard);
        editBtn.addEventListener('click', () => window.location.href = `/send/${postboxId}/write`);
        init();

    </script>
</body>
</html>
