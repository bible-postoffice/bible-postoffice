<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엽서/편지지 선택</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-strong: #2563eb;
            --accent: #10b981;
            --ink: #0f172a;
            --frame: #38bdf8;
            --frame-strong: #0ea5e9;
            --muted: #6b7280;
            --panel: #ffffff;
            --bg: #f5f7fb;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Pretendard', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--ink);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .shell {
            max-width: 1180px;
            width: 100%;
            margin: 0 auto;
            padding: 32px 20px 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            color: var(--ink);
        }
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            padding: 28px 24px 30px;
            box-shadow: 0 18px 60px rgba(15, 23, 42, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }
        h1 {
            margin: 0;
            font-size: 30px;
            letter-spacing: -0.03em;
            font-family: 'Noto Serif KR', 'Pretendard', system-ui, -apple-system, sans-serif;
        }
        .subtitle {
            color: #4b5563;
            margin-top: 8px;
            font-size: 16px;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #475569;
        }
        .step span {
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .step .current {
            background: rgba(59,130,246,0.14);
            border-color: rgba(59,130,246,0.35);
            color: #1d4ed8;
        }
        .toggle-bar {
            margin-top: 18px;
            display: flex;
            justify-content: center;
        }
        .toggle {
            position: relative;
            background: #f1f5f9;
            border: 1px solid #dfe3ea;
            border-radius: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 270px;
            overflow: hidden;
        }
        .toggle button {
            position: relative;
            padding: 12px 0;
            font-size: 15px;
            font-weight: 800;
            color: #475569;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 2;
        }
        .toggle .thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: calc(50% - 6px);
            height: calc(100% - 6px);
            background: linear-gradient(135deg, #3b82f6 0%, #5c9bff 100%);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(59,130,246,0.3);
            transition: transform 0.2s ease;
        }
        .stage {
            position: relative;
            margin-top: 20px;
            background: #f8fafc;
            border: 1px dashed #d0dbe8;
            border-radius: 20px;
            padding: 18px 16px;
            display: grid;
            place-items: center;
            flex: 1;
            min-height: 320px;
            min-width: 0;
            width: 100%;
            max-width: 100%;
        }
        .frame {
            position: relative;
            width: min(90vw, 820px);
            border: 2px solid var(--frame-strong);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: none;
            transition: width 0.2s ease, height 0.2s ease;
        }
        .frame.landscape {
            aspect-ratio: 3 / 2;
            height: clamp(320px, 52vh, 520px);
        }
        .frame.portrait {
            aspect-ratio: 2 / 3;
            height: clamp(360px, 64vh, 680px);
        }
        .preview-large {
            position: absolute;
            inset: 0;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: background 0.25s ease;
        }
        .preview-large::after { display: none; }
        .label {
            position: absolute;
            top: 14px;
            left: 14px;
            padding: 8px 12px;
            border-radius: 12px;
            background: rgba(255,255,255,0.85);
            color: #0f172a;
            font-weight: 800;
            backdrop-filter: blur(6px);
            border: 1px solid rgba(15,23,42,0.08);
        }
        .meta {
            position: absolute;
            left: 16px;
            right: 16px;
            bottom: 16px;
            color: #e2e8f0;
        }
        .name {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }
        .desc {
            color: #475569;
            font-size: 15px;
            margin-bottom: 10px;
        }
        .counter {
            font-size: 13px;
            color: var(--muted);
        }
        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: 2px solid #d0dbe8;
            background: #fff;
            color: #2563eb;
            font-size: 26px;
            font-weight: 900;
            cursor: pointer;
            display: grid;
            place-items: center;
            box-shadow: 0 15px 30px rgba(37,99,235,0.18);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        .arrow:hover { transform: translateY(-50%) scale(1.02); }
        .arrow:active { transform: translateY(-50%) scale(0.98); }
        .arrow.left { left: 12px; }
        .arrow.right { right: 12px; }
        .actions {
            margin-top: 14px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        .btn {
            padding: 14px 18px;
            border-radius: 12px;
            border: 2px solid var(--primary-strong);
            background: linear-gradient(135deg, #2b59ff 0%, #6c8bff 100%);
            color: #f8fafc;
            font-weight: 800;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(59,130,246,0.3);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn.secondary {
            background: #fff;
            color: #1f2937;
            border-color: #d0dbe8;
            box-shadow: none;
        }
        .hint {
            text-align: center;
            margin-top: 10px;
            color: var(--muted);
            font-size: 13px;
        }
        @media (max-width: 768px) {
            .frame { width: min(94vw, 560px); max-height: none; }
            .arrow { display: none; }
            .card { padding: 18px; }
            .shell { padding: 18px 14px 26px; }
            h1 { font-size: 22px; }
            .stage { min-height: 280px; padding: 14px 10px; }
        }
        @media (min-width: 1024px) {
            .shell { padding: 26px 22px; }
            .card { padding: 24px 26px 26px; }
            .stage { margin-top: 18px; }
            .frame { height: clamp(340px, 60vh, 640px); }
        }
        @media (max-width: 540px) {
            .header { flex-direction: column; align-items: flex-start; }
            .stage { padding: 12px 8px; }
            .frame { width: 100%; max-width: 100%; }
            .actions { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="shell">
        <div class="card">
            <div class="header">
                <div>
                    <h1>엽서/편지지 선택</h1>
                    <div class="subtitle">상단 토글로 종류를 고르고, 좌우 화살표나 스와이프로 템플릿을 살펴보세요.</div>
                </div>
                <div class="step">
                    <span class="current">1 · 선택</span>
                    <span>2 · 작성</span>
                    <span>3 · 미리보기</span>
                </div>
            </div>

            <div class="toggle-bar">
                <div class="toggle" id="toggle">
                    <div class="thumb" id="thumb"></div>
                    <button data-type="엽서">엽서</button>
                    <button data-type="편지지">편지지</button>
                </div>
            </div>

            <div class="stage">
                <button class="arrow left" id="prev-btn">&#x2039;</button>
                <div class="frame" id="frame">
                    <div class="preview-large" id="preview"></div>
                    <div class="label" id="type-label"></div>
                    <div class="meta">
                        <div class="name" id="name"></div>
                        <div class="desc" id="desc"></div>
                        <div class="counter" id="counter"></div>
                    </div>
                </div>
                <button class="arrow right" id="next-btn">&#x203a;</button>
            </div>

            <div class="actions">
                <button class="btn" id="select-btn" disabled>선택</button>
                <button class="btn secondary" id="back-btn">이전</button>
            </div>
            <div class="hint">엽서와 편지지는 서로 다른 템플릿만 보여줘요.</div>
        </div>
    </div>

    <script>
        const postboxId = "{{ postbox_id }}";
        const templates = [
            { id: 1, name: '항공 엽서', typeLabel: '엽서', type: 0, image: "{{ url_for('static', filename='images/postcards/POSTCARD1.png') }}" },
            { id: 2, name: '화원', typeLabel: '엽서', type: 0, image: "{{ url_for('static', filename='images/postcards/POSTCARD2.png') }}" },
            { id: 3, name: '하늘', typeLabel: '엽서', type: 0, image: "{{ url_for('static', filename='images/postcards/POSTCARD3.png') }}" },
            { id: 4, name: '크레용', typeLabel: '엽서', type: 0, image: "{{ url_for('static', filename='images/postcards/POSTCARD4.png') }}" },
            { id: 5, name: '큰 꽃', typeLabel: '편지지', type: 1, image: "{{ url_for('static', filename='images/letters/letter1.png') }}" },
            { id: 6, name: '크레용', typeLabel: '편지지', type: 1, image: "{{ url_for('static', filename='images/letters/letter2.png') }}" },
            { id: 7, name: '성경책', typeLabel: '편지지', type: 1, image: "{{ url_for('static', filename='images/letters/letter3.png') }}" },
            { id: 8, name: '화원', typeLabel: '편지지', type: 1, image: "{{ url_for('static', filename='images/letters/letter4.jpg') }}" },
        ];

        const previewEl = document.getElementById('preview');
        const typeLabelEl = document.getElementById('type-label');
        const nameEl = document.getElementById('name');
        const descEl = document.getElementById('desc');
        const counterEl = document.getElementById('counter');
        const selectBtn = document.getElementById('select-btn');
        const backBtn = document.getElementById('back-btn');
        const thumbEl = document.getElementById('thumb');
        const toggleEl = document.getElementById('toggle');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const frameEl = document.getElementById('frame');
        const stageEl = document.querySelector('.stage');

        let currentType = '엽서';
        let currentIndex = 0;

        const filteredTemplates = () => templates.filter(t => t.typeLabel === currentType);

        function render() {
            const list = filteredTemplates();
            if (!list.length) {
                selectBtn.disabled = true;
                previewEl.className = 'preview-large';
                previewEl.style.backgroundImage = '';
                nameEl.textContent = '';
                descEl.textContent = '';
                typeLabelEl.textContent = '';
                counterEl.textContent = '';
                return;
            }
            if (currentIndex >= list.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = list.length - 1;

            const tpl = list[currentIndex];
            previewEl.className = 'preview-large';
            previewEl.style.backgroundImage = tpl.image ? `url(${tpl.image})` : '';
            nameEl.textContent = '';
            descEl.textContent = '';
            typeLabelEl.textContent = '';
            counterEl.textContent = `${currentIndex + 1} / ${list.length}`;
            selectBtn.disabled = false;
            frameEl.classList.remove('landscape', 'portrait');
            frameEl.classList.add(tpl.typeLabel === '엽서' ? 'landscape' : 'portrait');
        }

        function setType(type) {
            currentType = type;
            currentIndex = 0;
            thumbEl.style.transform = type === '엽서' ? 'translateX(0)' : 'translateX(100%)';
            toggleEl.querySelectorAll('button').forEach(btn => {
                btn.style.color = btn.dataset.type === type ? '#fff1f2' : '#fecdd3';
            });
            render();
        }

        toggleEl.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => setType(btn.dataset.type));
        });

        prevBtn.addEventListener('click', () => {
            currentIndex -= 1;
            render();
        });
        nextBtn.addEventListener('click', () => {
            currentIndex += 1;
            render();
        });

        // swipe support for touch devices
        function enableSwipe(el) {
            let startX = 0;
            let startY = 0;
            let isTouch = false;
            const threshold = 40;
            el.addEventListener('touchstart', (e) => {
                if (!e.touches.length) return;
                isTouch = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });
            el.addEventListener('touchend', (e) => {
                if (!isTouch) return;
                const endX = (e.changedTouches && e.changedTouches[0].clientX) || startX;
                const endY = (e.changedTouches && e.changedTouches[0].clientY) || startY;
                const dx = endX - startX;
                const dy = endY - startY;
                if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > threshold) {
                    currentIndex += dx < 0 ? 1 : -1;
                    render();
                }
                isTouch = false;
            }, { passive: true });
        }
        // 터치 스와이프는 스테이지에서만 감지해 중복 이동을 방지
        enableSwipe(stageEl);

        selectBtn.addEventListener('click', () => {
            const list = filteredTemplates();
            if (!list.length) return;
            const tpl = list[currentIndex];
            const url = new URL(window.location.origin + `/send/${postboxId}/write`);
            url.searchParams.set('template_id', tpl.id);
            url.searchParams.set('template_type', tpl.type);
            url.searchParams.set('template_name', tpl.name);
            window.location.href = url.toString();
        });

        backBtn.addEventListener('click', () => {
            if (window.history.length > 1) window.history.back();
            else window.location.href = '/';
        });

        setType(currentType);
    </script>
</body>
</html>
