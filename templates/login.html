{% extends 'base.html' %}

{% block content %}
<div class="flex-1 flex items-center justify-center px-6 py-12">
    <div class="w-full max-w-md">
        <a href="/"
            class="inline-flex items-center text-sm text-slate-400 hover:text-primary dark:hover:text-accent mb-8 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            메인으로 돌아가기
        </a>

        <div class="mb-10">
            <h2 class="text-3xl font-bold font-serif text-slate-900 dark:text-white mb-2">다시 오셨군요!</h2>
            <p class="text-slate-500 dark:text-slate-400">아이디와 비밀번호를 입력해주세요.</p>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-700 text-sm rounded-r-xl">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form onsubmit="handleEmailLogin(event)" class="space-y-5">
            <div>
                <label for="email"
                    class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 ml-1">이메일</label>
                <input type="email" id="email" name="email" required autocomplete="username"
                    class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary dark:focus:ring-accent focus:border-transparent outline-none transition-all dark:text-white"
                    placeholder="example@mail.com">
            </div>

            <div>
                <div class="flex justify-between items-center mb-1.5 ml-1">
                    <label for="password"
                        class="block text-sm font-medium text-slate-700 dark:text-slate-300">비밀번호</label>
                    <a href="#" class="text-xs text-slate-400 hover:text-primary">비밀번호를 잊으셨나요?</a>
                </div>
                <input type="password" id="password" name="password" required autocomplete="current-password"
                    class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary dark:focus:ring-accent focus:border-transparent outline-none transition-all dark:text-white"
                    placeholder="비밀번호를 입력해주세요">
            </div>

            <button type="submit" id="login-btn"
                class="w-full py-4 bg-primary dark:bg-accent hover:opacity-90 text-white dark:text-slate-900 font-bold rounded-xl shadow-lg shadow-primary/20 dark:shadow-accent/20 transition-all transform active:scale-[0.98] mt-4">
                이메일로 로그인하기
            </button>
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
                <span class="flex-shrink-0 mx-4 text-slate-400 text-xs">또는</span>
                <div class="flex-grow border-t border-slate-200 dark:border-slate-700"></div>
            </div>
            <button type="button" onclick="handleKakaoLogin()"
                class="w-full py-4 bg-[#FEE500] hover:bg-[#FDD835] text-slate-900 font-bold rounded-xl shadow-lg shadow-yellow-400/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 3C5.925 3 1 6.925 1 11.775c0 3.325 2.275 6.25 5.725 7.825-.2.75-.725 2.725-.825 3.125-.125.45.175.45.375.3 1.55-1.075 3.225-2.225 4.15-2.875.525.075 1.05.125 1.575.125 6.075 0 11-3.925 11-8.775C23 6.925 18.075 3 12 3z" />
                </svg>
                카카오로 3초만에 시작하기
            </button>
        </form>

        <p class="mt-8 text-center text-sm text-slate-500 dark:text-slate-400">
            아직 회원이 아니신가요?
            <a href="/signup" class="text-primary dark:text-accent font-bold hover:underline ml-1">회원가입하기</a>
        </p>
    </div>
</div>

<script>

    {# global getRedirectBase from base.html used instead # }

    async function handleKakaoLogin() {
        if (!window.supabaseApp) {
            alert("서비스 초기화 오류. 새로고침 후 다시 시도해주세요.");
            return;
        }
        sessionStorage.removeItem('authChecked');

        const { data, error } = await window.supabaseApp.auth.signInWithOAuth({
            provider: 'kakao',
            options: {
                redirectTo: getRedirectBase(),
                queryParams: { prompt: 'login' }
            }
        });
        if (error) {
            alert("카카오 로그인 실패: " + error.message);
        }
    }

    async function handleEmailLogin(e) {
        e.preventDefault();
        if (!window.supabaseApp) return;

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('login-btn');

        btn.disabled = true;
        btn.innerText = "로그인 중...";

        const { data, error } = await window.supabaseApp.auth.signInWithPassword({
            email,
            password
        });

        if (error) {
            alert("로그인 실패: " + error.message);
            btn.disabled = false;
            btn.innerText = "로그인하기";
            return;
        }

        // 성공 시 세션 동기화
        syncSessionAndRedirect(data.session);
    }

    async function syncSessionAndRedirect(session) {
        if (!session) return;

        try {
            const response = await fetch('/auth/check-and-save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: session.access_token,
                    email: session.user.email
                })
            });

            const result = await response.json();
            if (result.success) {
                window.location.href = result.redirect_url || '/';
            } else {
                alert("로그인 처리 중 오류 발생: " + result.message);
            }
        } catch (e) {
            console.error(e);
            alert("서버 통신 오류가 발생했습니다.");
        }
    }

    // Check if we just came back from OAuth redirect
    (async function () {
        if (window.supabaseApp) {
            const { data: { session } } = await window.supabaseApp.auth.getSession();
            if (session) {
                window.supabaseApp.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        await syncSessionAndRedirect(session);
                    }
                });
            }
        }
    })();

</script>
{% endblock %}