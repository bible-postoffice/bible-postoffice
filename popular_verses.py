# popular_verses.py
import re
import unicodedata


def normalize_korean(text: str) -> str:
    """í•œê¸€ ë¬¸ìì—´ì„ NFCë¡œ ì •ê·œí™”"""
    if not isinstance(text, str):
        return text
    return unicodedata.normalize("NFC", text)

# ì±… ì´ë¦„ë³„ë¡œ ì¸ê¸° êµ¬ì ˆ ì •ì˜
POPULAR_VERSES_BY_BOOK = {
    "ìš”í•œë³µìŒ": {
        "3:16": 100,
        "14:6": 91,
        "1:1": 86,
        "14:27": 80,
        "10:10": 77,
        "16:33": 65,
        "15:13": 64,
        "8:32": 57,
        "4:24": 50,
        "11:25": 28,
        "13:34-35": 27,
        "13:34": 27,
        "13:35": 27,
        "15:5": 26,
        "17:3": 25,
        "20:29": 24,
        "6:35": 45,
    },
    "ì´ì‚¬ì•¼": {
        "41:10": 98,
        "40:31": 79,
        "40:28": 74,
        "53:5": 45,
        "40:8": 44,
        "9:6": 43,
        "26:3": 40,
        "43:2": 39,
        "55:8-9": 38,
        "55:8": 38,
        "55:9": 38,
        "64:8": 37,
        "12:2": 36,
        "30:21": 35,
    },
    "ì˜ˆë ˆë¯¸ì•¼": {
        "29:11": 97,
        "1:5": 33,
        "17:7-8": 32,
        "17:7": 32,
        "17:8": 32,
        "33:3": 31,
        "31:3": 29,
        "9:23-24": 28,
        "9:23": 28,
        "9:24": 28,
    },
    "ë¹Œë¦½ë³´ì„œ": {
        "4:13": 96,
        "4:6-7": 92,
        "4:6": 92,
        "4:7": 92,
        "4:8": 70,
        "2:1-11": 50,
        "1:6": 18,
        "3:13-14": 17,
        "3:13": 17,
        "3:14": 17,
        "2:3-4": 14,
        "2:3": 14,
        "2:4": 14,
    },
    "ì‹œí¸": {
        "23:1-6": 95,
        "23:1": 95,
        "23:2": 95,
        "23:3": 95,
        "23:4": 78,
        "23:5": 95,
        "23:6": 95,
        "91:1": 88,
        "46:1": 83,
        "119:105": 80,
        "27:1": 75,
        "34:18": 70,
        "37:4": 65,
        "62:1": 56,
        "103:12": 55,
        "1:1-3": 51,
        "1:1": 51,
        "1:2": 51,
        "1:3": 51,
        "95:1-6": 50,
        "100:1-5": 49,
        "29:2": 48,
        "73:25-26": 45,
        "25:4-5": 44,
        "121:1-2": 43,
        "139:13-14": 42,
        "46:10": 41,
        "34:8": 40,
        "42:1": 40,
        "16:8": 40,
        "28:7": 39,
        "31:24": 38,
        "37:23-24": 37,
        "40:1-3": 36,
        "55:22": 35,
        "63:1": 35,
        "68:19": 34,
        "84:11": 33,
        "86:5": 32,
        "90:12": 31,
        "118:24": 30,
        "127:1": 30,
        "130:5": 29,
        "143:8": 28,
        "145:18": 27,
        "147:3": 26,
        "150:6": 25,
        "18:2": 61,
        "51:10": 30,
    },
    "ë¡œë§ˆì„œ": {
        "8:28": 94,
        "12:2": 87,
        "5:8": 67,
        "3:23": 60,
        "10:9": 54,
        "12:1": 40,
        "1:16": 39,
        "15:13": 24,
        "8:31": 23,
        "8:38-39": 22,
        "8:38": 22,
        "8:39": 22,
        "5:3-5": 21,
        "14:8": 20,
        "6:23": 50,
    },
    "ì ì–¸": {
        "3:5-6": 93,
        "3:5": 93,
        "3:6": 93,
        "16:3": 76,
        "3:7-8": 42,
        "4:23": 41,
        "12:25": 40,
        "22:6": 39,
        "4:20-27": 35,
        "10:12": 34,
        "11:25": 33,
        "13:20": 32,
        "14:12": 31,
        "15:1": 30,
        "18:10": 30,
        "19:21": 29,
        "20:24": 28,
        "21:21": 27,
        "27:17": 26,
        "31:25": 25,
    },
    "ë§ˆíƒœë³µìŒ": {
        "28:19-20": 90,
        "28:19": 90,
        "28:20": 90,
        "6:33": 85,
        "11:28": 84,
        "22:37-39": 75,
        "5:16": 60,
        "7:7": 52,
        "5:3-12": 45,
        "5:14": 30,
        "6:9-13": 29,
        "18:20": 28,
        "25:40": 27,
    },
    "ê³ ë¦°ë„ì „ì„œ": {
        "13:4-8": 82,
        "13:4": 82,
        "13:5": 82,
        "13:6": 82,
        "13:7": 82,
        "13:8": 82,
        "10:13": 69,
        "15:58": 38,
        "6:19-20": 22,
        "16:13": 21,
        "2:9": 18,
    },
    "ì—ë² ì†Œì„œ": {
        "2:8-9": 81,
        "2:8": 81,
        "2:9": 81,
        "6:10-11": 71,
        "4:32": 59,
        "5:1-2": 36,
        "3:20": 50,
        "1:7": 19,
        "4:2-3": 18,
        "5:15-16": 17,
    },
    "ê³ ë¦°ë„í›„ì„œ": {
        "5:17": 73,
        "12:9": 37,
        "4:16-18": 20,
        "9:7": 19,
    },
    "ê°ˆë¼ë””ì•„ì„œ": {
        "5:22-23": 72,
        "2:20": 58,
        "6:9": 20,
        "5:16-26": 16,
    },
    "ì°½ì„¸ê¸°": {
        "1:1": 89,
        "1:27": 63,
        "50:20": 32,
        "1:26-31": 35,
        "2:24": 34,
        "15:1": 33,
        "28:15": 32,
        "9:13": 31,
        "22:14": 30,
        "32:28": 29,
        "39:2": 28,
    },
    "ì—¬í˜¸ìˆ˜ì•„": {
        "1:9": 80,
        "24:15": 34,
    },
    "ë² ë“œë¡œì „ì„œ": {
        "5:6-7": 75,
        "5:10": 60,
        "3:15": 8,
        "4:8": 7,
    },
    "íˆë¸Œë¦¬ì„œ": {
        "11:1": 75,
        "13:8": 62,
        "12:1-2": 53,
        "11:6": 38,
        "4:12": 12,
        "10:23": 11,
        "13:5": 10,
        "6:19": 9,
        "4:16": 8,
    },
    "ê³¨ë¡œìƒˆì„œ": {
        "3:23": 65,
        "1:15-20": 55,
        "3:2": 36,
        "3:12-14": 16,
        "2:6-7": 15,
    },
    "ì‹ ëª…ê¸°": {
        "31:6": 65,
        "6:4-5": 55,
        "8:3": 33,
    },
    "ì•¼ê³ ë³´ì„œ": {
        "1:2-3": 70,
        "1:19-27": 55,
        "2:26": 37,
        "1:5": 10,
        "4:7": 9,
    },
    "ìš”í•œì¼ì„œ": {
        "4:19": 68,
        "1:9": 35,
        "3:1": 34,
        "4:8": 8,
        "5:14-15": 7,
        "2:15-17": 4,
    },
    "ëˆ„ê°€ë³µìŒ": {
        "4:8": 66,
        "6:31": 46,
        "1:37": 26,
        "12:34": 26,
    },
    "ë””ëª¨ë°í›„ì„œ": {
        "3:16": 70,
        "1:7": 13,
        "2:15": 10,
    },
    "ì¶œì• êµ½ê¸°": {
        "14:14": 36,
        "15:2": 30,
        "19:5": 29,
        "20:12": 28,
        "33:14": 27,
        "3:14": 26,
        "23:25": 25,
    },
    "ë ˆìœ„ê¸°": {
        "19:18": 35,
    },
    "ë¯¼ìˆ˜ê¸°": {
        "6:24-26": 34,
    },
    "ì‚¬ì‚¬ê¸°": {
        "6:12": 32,
    },
    "ì‚¬ë¬´ì—˜ìƒ": {
        "16:7": 31,
    },
    "í•˜ë°•êµ­": {
        "3:19": 32,
        "2:14": 23,
        "3:17-18": 20,
    },
    "ë§ë¼ê¸°": {
        "3:10": 31,
    },
    "ìŠ¤ê°€ë´": {
        "4:6": 30,
    },
    "ìš”ì—˜": {
        "2:28": 29,
    },
    "ì•„ëª¨ìŠ¤": {
        "5:24": 28,
    },
    "ë§ˆê°€ë³µìŒ": {
        "8:35-36": 48,
        "12:30": 47,
        "16:15": 26,
    },
    "ë¯¸ê°€": {
        "6:8": 43,
        "7:7": 21,
    },
    "ì „ë„ì„œ": {
        "3:1": 38,
        "4:9-10": 38,
        "7:8": 18,
        "11:1": 16,
    },
    "ë² ë“œë¡œí›„ì„œ": {
        "3:9": 36,
        "1:3": 6,
    },
    "ëŠí—¤ë¯¸ì•¼": {
        "8:10": 60,
        "4:14": 17,
    },
    "ìš¥ê¸°": {
        "13:15": 30,
        "19:25": 27,
        "23:10": 26,
        "37:5": 25,
        "42:2": 24,
        "1:21": 23,
        "5:17": 22,
    },
    "ì—­ëŒ€ìƒ": {
        "16:29": 48,
        "28:20": 19,
    },
    "ìš”í•œê³„ì‹œë¡": {
        "4:11": 48,
        "21:4": 5,
        "3:20": 4,
        "1:8": 3,
        "22:13": 2,
    },
    "ì‚¬ë„í–‰ì „": {
        "1:8": 26,
        "2:38": 25,
        "4:12": 24,
        "16:31": 23,
        "20:35": 22,
    },
    "ì˜ˆë ˆë¯¸ì•¼ì• ê°€": {
        "3:22-23": 30,
    },
    "ì—ìŠ¤ê²”": {
        "36:26": 28,
        "37:5": 25,
    },
    "ë‹¤ë‹ˆì—˜": {
        "2:21": 27,
        "6:27": 26,
    },
    "í˜¸ì„¸ì•„": {
        "6:3": 26,
        "10:12": 24,
    },
    "ìš”ë‚˜": {
        "2:9": 25,
        "4:2": 23,
    },
    "ë‚˜í›”": {
        "1:7": 22,
    },
    "ìŠ¤ë°”ëƒ": {
        "3:17": 20,
        "2:3": 18,
    },
    "í•™ê°œ": {
        "2:4": 19,
    },
    "ë£»ê¸°": {
        "1:16": 22,
        "2:12": 20,
    },
    "ì—ìŠ¤ë”": {
        "4:14": 21,
    },
    "ì—´ì™•ê¸°ìƒ": {
        "19:12": 22,
        "8:56": 18,
    },
    "ì—­ëŒ€í•˜": {
        "7:14": 21,
    },
    "ì—´ì™•ê¸°í•˜": {
        "6:16": 20,
    },
    "ì—ìŠ¤ë¼": {
        "10:4": 18,
        "7:10": 16,
    },
    "ì•„ê°€": {
        "8:7": 17,
        "2:4": 15,
    },
    "ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ": {
        "5:16-18": 16,
        "5:11": 15,
        "4:13": 13,
    },
    "ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ": {
        "3:3": 14,
        "2:16-17": 12,
    },
    "ë””ëª¨ë°ì „ì„œ": {
        "4:12": 14,
        "6:12": 12,
    },
    "ë””ë„ì„œ": {
        "3:3-8": 11,
    },
    "ìš”í•œì´ì„œ": {
        "1:6": 6,
    },
    "ìš”í•œì‚¼ì„œ": {
        "1:4": 5,
    },
    "ìœ ë‹¤ì„œ": {
        "1:24-25": 6,
    },
}

# ì˜ë¬¸ -> í•œê¸€ ì±… ì´ë¦„ ë§¤í•‘
BOOK_NAME_MAP = {
    "Genesis": "ì°½ì„¸ê¸°",
    "Exodus": "ì¶œì• êµ½ê¸°",
    "Leviticus": "ë ˆìœ„ê¸°",
    "Numbers": "ë¯¼ìˆ˜ê¸°",
    "Deuteronomy": "ì‹ ëª…ê¸°",
    "Joshua": "ì—¬í˜¸ìˆ˜ì•„",
    "Judges": "ì‚¬ì‚¬ê¸°",
    "Ruth": "ë£»ê¸°",
    "1 Samuel": "ì‚¬ë¬´ì—˜ìƒ",
    "2 Samuel": "ì‚¬ë¬´ì—˜í•˜",
    "1 Kings": "ì—´ì™•ê¸°ìƒ",
    "2 Kings": "ì—´ì™•ê¸°í•˜",
    "1 Chronicles": "ì—­ëŒ€ìƒ",
    "2 Chronicles": "ì—­ëŒ€í•˜",
    "Ezra": "ì—ìŠ¤ë¼",
    "Nehemiah": "ëŠí—¤ë¯¸ì•¼",
    "Esther": "ì—ìŠ¤ë”",
    "Job": "ìš¥ê¸°",
    "Psalms": "ì‹œí¸",
    "Proverbs": "ì ì–¸",
    "Ecclesiastes": "ì „ë„ì„œ",
    "Song of Solomon": "ì•„ê°€",
    "Isaiah": "ì´ì‚¬ì•¼",
    "Jeremiah": "ì˜ˆë ˆë¯¸ì•¼",
    "Lamentations": "ì˜ˆë ˆë¯¸ì•¼ì• ê°€",
    "Ezekiel": "ì—ìŠ¤ê²”",
    "Daniel": "ë‹¤ë‹ˆì—˜",
    "Hosea": "í˜¸ì„¸ì•„",
    "Joel": "ìš”ì—˜",
    "Amos": "ì•„ëª¨ìŠ¤",
    "Obadiah": "ì˜¤ë°”ëŒœ",
    "Jonah": "ìš”ë‚˜",
    "Micah": "ë¯¸ê°€",
    "Nahum": "ë‚˜í›”",
    "Habakkuk": "í•˜ë°•êµ­",
    "Zephaniah": "ìŠ¤ë°”ëƒ",
    "Haggai": "í•™ê°œ",
    "Zechariah": "ìŠ¤ê°€ë´",
    "Malachi": "ë§ë¼ê¸°",
    "Matthew": "ë§ˆíƒœë³µìŒ",
    "Mark": "ë§ˆê°€ë³µìŒ",
    "Luke": "ëˆ„ê°€ë³µìŒ",
    "John": "ìš”í•œë³µìŒ",
    "Acts": "ì‚¬ë„í–‰ì „",
    "Romans": "ë¡œë§ˆì„œ",
    "1 Corinthians": "ê³ ë¦°ë„ì „ì„œ",
    "2 Corinthians": "ê³ ë¦°ë„í›„ì„œ",
    "Galatians": "ê°ˆë¼ë””ì•„ì„œ",
    "Ephesians": "ì—ë² ì†Œì„œ",
    "Philippians": "ë¹Œë¦½ë³´ì„œ",
    "Colossians": "ê³¨ë¡œìƒˆì„œ",
    "1 Thessalonians": "ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ",
    "2 Thessalonians": "ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ",
    "1 Timothy": "ë””ëª¨ë°ì „ì„œ",
    "2 Timothy": "ë””ëª¨ë°í›„ì„œ",
    "Titus": "ë””ë„ì„œ",
    "Philemon": "ë¹Œë ˆëª¬ì„œ",
    "Hebrews": "íˆë¸Œë¦¬ì„œ",
    "James": "ì•¼ê³ ë³´ì„œ",
    "1 Peter": "ë² ë“œë¡œì „ì„œ",
    "2 Peter": "ë² ë“œë¡œí›„ì„œ",
    "1 John": "ìš”í•œì¼ì„œ",
    "2 John": "ìš”í•œì´ì„œ",
    "3 John": "ìš”í•œì‚¼ì„œ",
    "Jude": "ìœ ë‹¤ì„œ",
    "Revelation": "ìš”í•œê³„ì‹œë¡",
}

def extract_chapter_verse(text):
    """
    í…ìŠ¤íŠ¸ì—ì„œ ì¥:ì ˆ ì¶”ì¶œ
    ì˜ˆ: "ê³ í›„1:1 <ê³ ë‚œê³¼ ìœ„ë¡œ..." -> "1:1"
    """
    text = normalize_korean(text)  # â­ ì¶”ê°€
    match = re.search(r'[ê°€-í£]+(\d+:\d+)', text[:50])
    if match:
        return match.group(1)
    return None

def get_popularity_score(book_name, document_text=""):
    """
    ì±… ì´ë¦„ê³¼ ë¬¸ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¡°í•©í•˜ì—¬ ì¸ê¸°ë„ ì ìˆ˜ ê³„ì‚°
    """
    # 1) í•œê¸€ ì •ê·œí™” (á„€á…©á„…á…µá†«á„ƒá…©á„’á…®á„‰á…¥ â†’ ê³ ë¦°ë„í›„ì„œ)
    book_name = normalize_korean(book_name)

    # 2) ì˜ë¬¸ â†’ í•œê¸€ ë³€í™˜
    korean_book_name = BOOK_NAME_MAP.get(book_name, book_name)

    # 3) ë¬¸ì„œì—ì„œ ì¥:ì ˆ ì¶”ì¶œ
    chapter_verse = extract_chapter_verse(document_text)

    # 4) ì¸ê¸° êµ¬ì ˆ ì²´í¬
    if korean_book_name in POPULAR_VERSES_BY_BOOK and chapter_verse:
        verses = POPULAR_VERSES_BY_BOOK[korean_book_name]
        if chapter_verse in verses:
            return verses[chapter_verse]

    # ê¸°ë³¸ê°’
    return 30




# í†µê³„ ì •ë³´ ì¶œë ¥ìš© í•¨ìˆ˜
def get_popularity_stats():
    """ì¸ê¸° êµ¬ì ˆ í†µê³„ ë°˜í™˜"""
    total = len(POPULAR_VERSES)
    top_tier = sum(1 for score in POPULAR_VERSES.values() if score >= 80)
    high_tier = sum(1 for score in POPULAR_VERSES.values() if 50 <= score < 80)
    
    return {
        "total_verses": total,
        "top_tier (â‰¥80ì )": top_tier,
        "high_tier (50-79ì )": high_tier,
        "average_score": round(sum(POPULAR_VERSES.values()) / total, 1)
    }


if __name__ == '__main__':
    # í…ŒìŠ¤íŠ¸
    stats = get_popularity_stats()
    print("ğŸ“Š ì¸ê¸° êµ¬ì ˆ í†µê³„:")
    for key, value in stats.items():
        print(f"   {key}: {value}")
